<!doctype html><html lang=en><head><title>GitLab Upgrade</title>
<meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><link rel=canonical href=https://codex-devlab.github.io/posts/tools/sub-gitlab/gitlab-upgrade/><meta name=title content="GitLab Upgrade"><meta name=description content="Gitlab Upgrade History Gitlab의 업그레이드 과정은 하단의 Upgrade Path(https://docs.gitlab.com/ee/update/#upgrade-paths)를 준수 하며 진행해야 합니다.
위 경로대로 업그레이드를 진행하지 않으면, 하위 호완성의 문제로 구동이 불가능 하거나 데이터 베이스 오류등 다양한 에러가 발생 할 수 있습니다.
None Stop 업그레이드는 이중화 구성이 되어있지 않은 인스턴스에서는 불가능 하기에, 업그레이드 과정중에는 반드시 서비스의 중단을 공지한 후 진행하시기 바랍니다.
마 …"><meta name=author content="Codex"><meta name=naver-site-verification content="b2524fe501f608ead516ec8070aeb765b091b2f1"><meta name=google-site-verification content="EKpWUHeRAlcAGBCXOjr_mjGQb7GKLHDq4MjEIBbrfUc"><script type=application/ld+json>{"@context":"https://schema.org","@type":"Organization","name":"CodeXlog","url":"https:\/\/codex-devlab.github.io\/","logo":"\/images\/site\/illust.yh_logo.png"}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/codex-devlab.github.io\/posts\/tools\/sub-gitlab\/gitlab-upgrade\/"},"headline":"GitLab Upgrade","description":"","image":"\/images\/site\/illust.yh_logo.png","author":{"@type":"Person","name":"Codex"},"publisher":{"@type":"Organization","name":"CodeXlog","logo":{"@type":"ImageObject","url":"\/images\/site\/illust.yh_logo.png"}},"datePublished":"2023-03-22","dateModified":"2023-03-22"}</script><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><link rel=stylesheet href=/application.47c9c4df356338566fd2dec7d647c52e085304bca8f37fcced5fa425dc60a01b.css integrity="sha256-R8nE3zVjOFZv0t7H1kfFLghTBLyo83/M7V+kJdxgoBs="><link rel=icon type=image/png href=/images/site/illust.yh_logo_hu_7ef18759bfe81647.png><meta property="og:url" content="https://codex-devlab.github.io/posts/tools/sub-gitlab/gitlab-upgrade/"><meta property="og:site_name" content="CodeXlog"><meta property="og:title" content="GitLab Upgrade"><meta property="og:description" content="Gitlab Upgrade History Gitlab의 업그레이드 과정은 하단의 Upgrade Path(https://docs.gitlab.com/ee/update/#upgrade-paths)를 준수 하며 진행해야 합니다.
위 경로대로 업그레이드를 진행하지 않으면, 하위 호완성의 문제로 구동이 불가능 하거나 데이터 베이스 오류등 다양한 에러가 발생 할 수 있습니다.
None Stop 업그레이드는 이중화 구성이 되어있지 않은 인스턴스에서는 불가능 하기에, 업그레이드 과정중에는 반드시 서비스의 중단을 공지한 후 진행하시기 바랍니다.
마지막으로 업그레이드 과정에서 Gitlab Rails에서 Background Migration 작업을 진행 하게 되는데, 해당 과정은 Major 버전이 올라가거나, 업그레이드 경로 상 마지막 과정에서 상당 시간이 소요 됩니다."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-03-22T08:12:43+05:00"><meta property="article:modified_time" content="2023-03-22T08:12:43+05:00"><meta property="article:tag" content="GitLab"><meta property="article:tag" content="Manual"><meta property="article:tag" content="Upgrade"><meta name=twitter:card content="summary"><meta name=twitter:title content="GitLab Upgrade"><meta name=twitter:description content="Gitlab Upgrade History Gitlab의 업그레이드 과정은 하단의 Upgrade Path(https://docs.gitlab.com/ee/update/#upgrade-paths)를 준수 하며 진행해야 합니다.
위 경로대로 업그레이드를 진행하지 않으면, 하위 호완성의 문제로 구동이 불가능 하거나 데이터 베이스 오류등 다양한 에러가 발생 할 수 있습니다.
None Stop 업그레이드는 이중화 구성이 되어있지 않은 인스턴스에서는 불가능 하기에, 업그레이드 과정중에는 반드시 서비스의 중단을 공지한 후 진행하시기 바랍니다.
마지막으로 업그레이드 과정에서 Gitlab Rails에서 Background Migration 작업을 진행 하게 되는데, 해당 과정은 Major 버전이 올라가거나, 업그레이드 경로 상 마지막 과정에서 상당 시간이 소요 됩니다."><meta name=description content="GitLab Upgrade"><script async src="https://www.googletagmanager.com/gtag/js?id=G-FSLRPDG57K"></script><script>var dnt,doNotTrack=!1;if(null&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-FSLRPDG57K")}</script><script integrity="sha256-DO4ugzEwhTW1Id1UIWn0gUJWaebCYOypeTit6LW4QB4=">let theme=localStorage.getItem("theme-scheme")||localStorage.getItem("darkmode:color-scheme")||"light";theme==="system"&&(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?theme="dark":theme="light"),document.documentElement.setAttribute("data-theme",theme)</script></head><body class="type-posts kind-page" data-bs-spy=scroll data-bs-target=#TableOfContents data-bs-offset=80><div class="container-fluid bg-secondary wrapper"><nav class="navbar navbar-expand-xl top-navbar shadow" id=top-navbar><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button>
<i data-feather=sidebar></i>
</button>
<a class=navbar-brand href=/><img src=/images/site/illust.yh_logo_hu_7ef18759bfe81647.png id=logo alt=Logo>
CodeXlog</a>
<button class="navbar-toggler navbar-light" id=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#top-nav-items aria-label=menu>
<i data-feather=menu></i></button><div class="collapse navbar-collapse dynamic-navbar" id=top-nav-items><ul class="nav navbar-nav ms-auto"><li class=nav-item><a class=nav-link href=/#home>Home</a></li><li class=nav-item><a class=nav-link href=/#recent-posts>Recent Posts</a></li><div id=top-navbar-divider></div><li class=nav-item><a class=nav-link id=blog-link href=/posts>Posts</a></li><li class=nav-item><a class=nav-link href=/tags/>Tags</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=themeSelector role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false><img id=navbar-theme-icon-svg class=theme-icon src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme"></a><div id=themeMenu class="dropdown-menu dropdown-menu-icons-only" aria-labelledby=themeSelector><a class="dropdown-item nav-link" href=# data-scheme=light><img class=theme-icon src=/icons/sun-svgrepo-com.svg width=20 alt="Light Theme">
</a><a class="dropdown-item nav-link" href=# data-scheme=dark><img class=theme-icon src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme">
</a><a class="dropdown-item nav-link" href=# data-scheme=system><img class=theme-icon src=/icons/computer-svgrepo-com.svg width=20 alt="System Theme"></a></div></li></ul></div></div><img src=/images/site/illust.yh_logo_hu_7ef18759bfe81647.png class=d-none id=main-logo alt=Logo>
<img src=/images/site/illust.yh_logo_hu_7ef18759bfe81647.png class=d-none id=inverted-logo alt="Inverted Logo"></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=/search><input type=text name=keyword placeholder=Search data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/posts/ data-filter=all>Posts</a></li><div class=subtree><li><i data-feather=plus-circle></i><a class=list-link href=/posts/blog-migration/> Blog-Migration</a><ul><li><a class=list-link href=/posts/blog-migration/sub-hugo/ title=Hugo>Hugo</a></li><li><a class=list-link href=/posts/blog-migration/sub-jekyll/ title=Jekyll>Jekyll</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/study/> Study</a><ul><li><i data-feather=plus-circle></i><a class=list-link href=/posts/study/sub-algorithms/> Algorithms</a><ul><li><i data-feather=plus-circle></i><a class=list-link href=/posts/study/sub-algorithms/online-judge/> Algorithms Problem</a><ul><li><i data-feather=plus-circle></i><a class=list-link href=/posts/study/sub-algorithms/online-judge/backjoon/> Backjoon</a><ul><li><a class=list-link href=/posts/study/sub-algorithms/online-judge/backjoon/step-prob/prob-100039/ title=Problem.100039>Problem.100039</a></li><li><a class=list-link href=/posts/study/sub-algorithms/online-judge/backjoon/step-prob/prob-1065/ title=Problem.1065>Problem.1065</a></li><li><a class=list-link href=/posts/study/sub-algorithms/online-judge/backjoon/step-prob/prob-10809/ title=Problem.10809>Problem.10809</a></li><li><a class=list-link href=/posts/study/sub-algorithms/online-judge/backjoon/step-prob/prob-10871/ title=Problem.10871>Problem.10871</a></li><li><a class=list-link href=/posts/study/sub-algorithms/online-judge/backjoon/step-prob/prob-1110/ title=Problem.1110>Problem.1110</a></li><li><a class=list-link href=/posts/study/sub-algorithms/online-judge/backjoon/step-prob/prob-1152/ title=Problem.1152>Problem.1152</a></li><li><a class=list-link href=/posts/study/sub-algorithms/online-judge/backjoon/step-prob/prob-1157/ title=Problem.1157>Problem.1157</a></li><li><a class=list-link href=/posts/study/sub-algorithms/online-judge/backjoon/step-prob/prob-11654/ title=Problem.11654>Problem.11654</a></li><li><a class=list-link href=/posts/study/sub-algorithms/online-judge/backjoon/step-prob/prob-11718/ title=Problem.11718>Problem.11718</a></li><li><a class=list-link href=/posts/study/sub-algorithms/online-judge/backjoon/step-prob/prob-11719/ title=Problem.11719>Problem.11719</a></li><li><a class=list-link href=/posts/study/sub-algorithms/online-judge/backjoon/step-prob/prob-11720/ title=Problem.11720>Problem.11720</a></li><li><a class=list-link href=/posts/study/sub-algorithms/online-judge/backjoon/step-prob/prob-11721/ title=Problem.11721>Problem.11721</a></li><li><a class=list-link href=/posts/study/sub-algorithms/online-judge/backjoon/step-prob/prob-1316/ title=Problem.1316>Problem.1316</a></li><li><a class=list-link href=/posts/study/sub-algorithms/online-judge/backjoon/step-prob/prob-1546/ title=Problem.1546>Problem.1546</a></li><li><a class=list-link href=/posts/study/sub-algorithms/online-judge/backjoon/step-prob/prob-15552/ title=Problem.15552>Problem.15552</a></li><li><a class=list-link href=/posts/study/sub-algorithms/online-judge/backjoon/step-prob/prob-1924/ title=Problem.1924>Problem.1924</a></li><li><a class=list-link href=/posts/study/sub-algorithms/online-judge/backjoon/step-prob/prob-1978/ title=Problem.1978>Problem.1978</a></li><li><a class=list-link href=/posts/study/sub-algorithms/online-judge/backjoon/step-prob/prob-2257/ title=Problem.2257>Problem.2257</a></li><li><a class=list-link href=/posts/study/sub-algorithms/online-judge/backjoon/step-prob/prob-2439/ title=Problem.2439>Problem.2439</a></li><li><a class=list-link href=/posts/study/sub-algorithms/online-judge/backjoon/step-prob/prob-2441/ title=Problem.2441>Problem.2441</a></li><li><a class=list-link href=/posts/study/sub-algorithms/online-judge/backjoon/step-prob/prob-2448/ title=Problem.2448>Problem.2448</a></li><li><a class=list-link href=/posts/study/sub-algorithms/online-judge/backjoon/step-prob/prob-2490/ title=Problem.2490>Problem.2490</a></li><li><a class=list-link href=/posts/study/sub-algorithms/online-judge/backjoon/step-prob/prob-2675/ title=Problem.2675>Problem.2675</a></li><li><a class=list-link href=/posts/study/sub-algorithms/online-judge/backjoon/step-prob/prob-2839/ title=Problem.2839>Problem.2839</a></li><li><a class=list-link href=/posts/study/sub-algorithms/online-judge/backjoon/step-prob/prob-2908/ title=Problem.2908>Problem.2908</a></li><li><a class=list-link href=/posts/study/sub-algorithms/online-judge/backjoon/step-prob/prob-2920/ title=Problem.2920>Problem.2920</a></li><li><a class=list-link href=/posts/study/sub-algorithms/online-judge/backjoon/step-prob/prob-2941/ title=Problem.2941>Problem.2941</a></li><li><a class=list-link href=/posts/study/sub-algorithms/online-judge/backjoon/step-prob/prob-4673/ title=Problem.4673>Problem.4673</a></li><li><a class=list-link href=/posts/study/sub-algorithms/online-judge/backjoon/step-prob/prob-5622/ title=Problem.5622>Problem.5622</a></li><li><a class=list-link href=/posts/study/sub-algorithms/online-judge/backjoon/step-prob/prob-8393/ title=Problem.8393>Problem.8393</a></li><li><a class=list-link href=/posts/study/sub-algorithms/online-judge/backjoon/step-prob/prob-8958/ title=Problem.8958>Problem.8958</a></li><li><a class=list-link href=/posts/study/sub-algorithms/online-judge/backjoon/step-prob/prob-9461/ title=Problem.9461>Problem.9461</a></li></ul></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/study/sub-algorithms/programming-tips/> Programming Tips</a><ul><li><a class=list-link href=/posts/study/sub-algorithms/programming-tips/the-meaning-of-scanf-in-c-language/ title="C언어 Scanf 의 의미">C언어 Scanf 의 의미</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/study/sub-algorithms/etc-problems/> Etc Problem</a><ul><li><a class=list-link href=/posts/study/sub-algorithms/etc-problems/prob-snail/ title="Prob 달팽이 배열">Prob 달팽이 배열</a></li><li><a class=list-link href=/posts/study/sub-algorithms/etc-problems/basic-problem/ title="기초 문제">기초 문제</a></li><li><a class=list-link href=/posts/study/sub-algorithms/etc-problems/various-pattern-output/ title="다양한 패턴 출력">다양한 패턴 출력</a></li><li><a class=list-link href=/posts/study/sub-algorithms/etc-problems/prob-bigandsmall/ title="큰수 작은수로 정렬후 덧셈">큰수 작은수로 정렬후 덧셈</a></li><li><a class=list-link href=/posts/study/sub-algorithms/etc-problems/prob-pascal-triangle/ title="파스칼의 삼각형">파스칼의 삼각형</a></li></ul></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/study/sub-computer-science/> Computer Science</a><ul><li><a class=list-link href=/posts/study/sub-computer-science/embedded-system/ title="시스템프로그래밍 FTW 구현">시스템프로그래밍 FTW 구현</a></li><li><a class=list-link href=/posts/study/sub-computer-science/system-programming-ftw-implementation/ title="시스템프로그래밍 FTW 구현">시스템프로그래밍 FTW 구현</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/study/sub-programming-language/> Programming Language</a><ul><li><i data-feather=plus-circle></i><a class=list-link href=/posts/study/sub-programming-language/sub-python/> Python</a><ul><li><a class=list-link href=/posts/study/sub-programming-language/sub-python/basic-python/ title="Python 기초">Python 기초</a></li></ul></li><li><a class=list-link href=/posts/study/sub-programming-language/study-c-language/ title="C언어 스터디">C언어 스터디</a></li><li><a class=list-link href=/posts/study/sub-programming-language/1-byte-unit-access-by-forced-casting/ title="강제 캐스팅에 의한 1byte 단위 접근법">강제 캐스팅에 의한 1byte 단위 접근법</a></li></ul></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/dev/> Dev</a><ul><li><i data-feather=plus-circle></i><a class=list-link href=/posts/dev/sub-projects/> Tips</a><ul><li><i data-feather=plus-circle></i><a class=list-link href=/posts/dev/sub-projects/sub-text-recognizer-on-ec2/> AWS text recognizer</a><ul><li><a class=list-link href=/posts/dev/sub-projects/sub-text-recognizer-on-ec2/text-recognizer-on-ec2-dev-history/ title="AWS project 진행 과정">AWS project 진행 과정</a></li><li><a class=list-link href=/posts/dev/sub-projects/sub-text-recognizer-on-ec2/text-recognizer-on-ec2-main/ title="AWS 이미지속 글자 추출">AWS 이미지속 글자 추출</a></li><li><a class=list-link href=/posts/dev/sub-projects/sub-text-recognizer-on-ec2/text-recognizer-on-ec2-django/ title="Django 따라해보기!!">Django 따라해보기!!</a></li></ul></li></ul></li><li><a class=list-link href=/posts/dev/sub-tips/ title=Tips>Tips</a></li><li><a class=list-link href=/posts/dev/git-manual/ title="Git Manual">Git Manual</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/os/> OS</a><ul><li><a class=list-link href=/posts/os/sub-bsd-based/ title="BSD-Based OS">BSD-Based OS</a></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/os/sub-linux/> Linux</a><ul><li><i data-feather=plus-circle></i><a class=list-link href=/posts/os/sub-linux/debian-bases/> Debain-Based OS</a><ul><li><a class=list-link href=/posts/os/sub-linux/debian-bases/ubuntu-setting/ title="Ubuntu & OSX setting">Ubuntu & OSX setting</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/os/sub-linux/rhel-based/> RHEL-Based OS</a><ul><li><a class=list-link href=/posts/os/sub-linux/rhel-based/centos-7-setting/ title="CentOS 7">CentOS 7</a></li></ul></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/os/sub-macos/> Mac OS</a><ul><li><a class=list-link href=/posts/os/sub-macos/mac-autojump/ title="Mac Autojump 설치및 사용법">Mac Autojump 설치및 사용법</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/posts/os/sub-window/> Window OS</a><ul><li><a class=list-link href=/posts/os/sub-window/window-git-setting/ title="Git 설치 및 초기설정">Git 설치 및 초기설정</a></li></ul></li></ul></li><li><i data-feather=minus-circle></i><a class="active list-link" href=/posts/tools/> Tools</a><ul class=active><li><i data-feather=minus-circle></i><a class="active list-link" href=/posts/tools/sub-gitlab/> GitLab</a><ul class=active><li><a class="active list-link" href=/posts/tools/sub-gitlab/gitlab-upgrade/ title="GitLab Upgrade">GitLab Upgrade</a></li></ul></li></ul></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(/images/posts/gitlab_logo.png)></div><div class=page-content><div class="author-profile ms-auto align-self-lg-center"><img class=rounded-circle src=/images/author/pigeon.gif alt="Author Image"><h5 class=author-name>DongjuSon</h5><p class=text-muted>Wednesday, March 22, 2023 | 17 minutes</p></div><div class=title><h1>GitLab Upgrade</h1></div><div class=tags><ul style=padding-left:0><li class=rounded><a href=/tags/gitlab/ class="btn btn-sm btn-info">GitLab</a></li><li class=rounded><a href=/tags/manual/ class="btn btn-sm btn-info">Manual</a></li><li class=rounded><a href=/tags/upgrade/ class="btn btn-sm btn-info">Upgrade</a></li></ul></div><div class=post-content id=post-content><h1 id=gitlab-upgrade-history>Gitlab Upgrade History</h1><p>Gitlab의 업그레이드 과정은 하단의 Upgrade Path(<a href=https://docs.gitlab.com/ee/update/#upgrade-paths target=_blank rel=noopener>https://docs.gitlab.com/ee/update/#upgrade-paths</a>)를 준수 하며 진행해야 합니다.</p><p>위 경로대로 업그레이드를 진행하지 않으면, 하위 호완성의 문제로 구동이 불가능 하거나 데이터 베이스 오류등 다양한 에러가 발생 할 수 있습니다.</p><p>None Stop 업그레이드는 이중화 구성이 되어있지 않은 인스턴스에서는 불가능 하기에, 업그레이드 과정중에는 반드시 서비스의 중단을 공지한 후 진행하시기 바랍니다.</p><p>마지막으로 업그레이드 과정에서 Gitlab Rails에서 Background Migration 작업을 진행 하게 되는데, 해당 과정은 Major 버전이 올라가거나, 업그레이드 경로 상 마지막 과정에서 상당 시간이 소요 됩니다.</p><blockquote><p>다음 버전으로의 업그레이드느 반드시 Background Migration 작업이 완료 된 후 진행해야 합니다.</p></blockquote><h2 id=upgrade-path>Upgrade Path</h2><ol><li><p>현재 사용중인 버전의 가장 최신 패치 버전으로 업그레이드.</p><p>ex) 11.10.6 (현재 11.10.x 버전) →11.10.8 (11.10.x 중 최신)</p></li><li><p>이전 마이너의 최신 패치 버전에서 다음 마이너의 초기 버전으로 업그레이드</p><p>ex) 11.10.8 (11.10.x 중 최신)→11.11.0 (11.11.x 초기 버전)</p></li><li><p>현재 마이너의 최신 패치 버전으로 업그레이드</p><p>ex) 11.11.0 (11.11.x 초기 버전)→11.11.8 (11.11.x 중 최신)</p></li><li><p>현재 메이저 버전중 가장 최신 버전에서 다음 메이저의 최초 마이너의 최신 패치 버전으로 업그레이드</p><p>ex) 11.11.8 (11.11.x 중 최신)→12.0.12 (12.0.x 중 최신)</p></li><li><p>Gitlab Upgrade paths에 따라 업그레이드 진행</p><p>8.11.Z -> 8.12.0 -> 8.17.7 -> 9.0.13 -> 9.5.10 -> 10.0.7 -> 10.8.7 -> 11.0.6 -> 11.11.8 -> 12.0.12 -> 12.1.17 -> 12.10.14 -> 13.0.14 -> 13.1.11 -> 13.8.8 -> 13.12.15 -> 14.0.12 -> 14.3.6 -> 14.9.5 -> 14.10.Z -> 15.0.Z -> 15.1.Z (for GitLab instances with multiple web nodes) -> 15.4.0 -> latest 15.Y.Z</p><p>14.10.5→15.0.5→15.1.6→15.4.0→15.5.6→15.6.2</p></li></ol><h2 id=upgrade-guide>Upgrade Guide</h2><blockquote><p>11.10.8-ce.0 버전에서 시작</p></blockquote><ul><li><p>docker 이미지 pull</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>docker pull gitlab<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>-</span>ce:11.<span style=color:#a6e22e>10</span>.<span style=color:#a6e22e>8</span><span style=color:#f92672>-</span>ce.<span style=color:#a6e22e>0</span>
</span></span></code></pre></div></li><li><p>Main Server에서 Gitlab 폴더 생성</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>mkdir <span style=color:#f92672>-</span>p <span style=color:#f92672>/</span>Image<span style=color:#f92672>/</span>custom_dev_gitlab<span style=color:#f92672>/</span>
</span></span></code></pre></div></li><li><p>Gitlab Server에서 Main Server로 config 폴더 복사</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>scp <span style=color:#f92672>-</span>r <span style=color:#f92672>/</span>data<span style=color:#f92672>/</span>docker<span style=color:#f92672>/</span>custom_dev_gitlab<span style=color:#f92672>/</span>config root<span style=color:#a6e22e>@172.29.241.100</span>:<span style=color:#f92672>/</span>Image<span style=color:#f92672>/</span>custom_dev_gitlab<span style=color:#f92672>/</span>
</span></span></code></pre></div></li><li><p>Main Server에서 Docker Dompose 파일 작성</p><p><code>vi /Image/custom_dev_gitlab/docker-compose.yml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>services:
</span></span><span style=display:flex><span>  web:
</span></span><span style=display:flex><span>    image: <span style=color:#960050;background-color:#1e0010>&#39;</span>gitlab<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>-</span>ce:11.<span style=color:#a6e22e>10</span>.<span style=color:#a6e22e>8</span><span style=color:#f92672>-</span>ce.<span style=color:#a6e22e>0</span><span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>    restart: always
</span></span><span style=display:flex><span>    hostname: <span style=color:#960050;background-color:#1e0010>&#39;</span>dev<span style=color:#f92672>-</span>gitlab<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>    container_name: custom_dev_gitlab
</span></span><span style=display:flex><span>    environment:
</span></span><span style=display:flex><span>      GITLAB_OMNIBUS_CONFIG: <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>#</span> Add any other gitlab.<span style=color:#a6e22e>rb</span> configuration here, each on its own line
</span></span><span style=display:flex><span>        external_url <span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>&lt;</span>http:<span style=color:#75715e>//182.114.70.81:32000&gt;&#39;</span>
</span></span><span style=display:flex><span>        gitlab_rails<span style=color:#f92672>[</span><span style=color:#960050;background-color:#1e0010>&#39;</span>gitlab_shell_ssh_port<span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> 8102
</span></span><span style=display:flex><span>    ports:
</span></span><span style=display:flex><span>      <span style=color:#f92672>-</span> <span style=color:#960050;background-color:#1e0010>&#39;</span>32000:32000<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>-</span> <span style=color:#960050;background-color:#1e0010>&#39;</span>8102:22<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>    volumes:
</span></span><span style=display:flex><span>      <span style=color:#f92672>-</span> <span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>/</span>Storage<span style=color:#f92672>/</span>docker<span style=color:#f92672>/</span>custom_dev_gitlab<span style=color:#f92672>/</span>config:<span style=color:#f92672>/</span>etc<span style=color:#f92672>/</span>gitlab<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>-</span> <span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>/</span>Storage<span style=color:#f92672>/</span>docker<span style=color:#f92672>/</span>custom_dev_gitlab<span style=color:#f92672>/</span>logs:<span style=color:#f92672>/</span>var<span style=color:#f92672>/</span>log<span style=color:#f92672>/</span>gitlab<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>-</span> <span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>/</span>Storage<span style=color:#f92672>/</span>docker<span style=color:#f92672>/</span>custom_dev_gitlab<span style=color:#f92672>/</span>data:<span style=color:#f92672>/</span>var<span style=color:#f92672>/</span>opt<span style=color:#f92672>/</span>gitlab<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>-</span> <span style=color:#f92672>/</span>etc<span style=color:#f92672>/</span>localtime:<span style=color:#f92672>/</span>etc<span style=color:#f92672>/</span>localtime:ro
</span></span></code></pre></div></li><li><p>Docker Compose 시작</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>docker compose up <span style=color:#f92672>-</span>d
</span></span></code></pre></div></li><li><p>Gitlab 컨테이너 로그 확인</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>docker logs <span style=color:#f92672>-</span>f custom_dev_gitlab
</span></span></code></pre></div></li><li><p>Gitlab Server에서 Main Server로 백업 파일 복사</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>scp <span style=color:#f92672>/</span>data<span style=color:#f92672>/</span>docker<span style=color:#f92672>/</span>custom_dev_gitlab<span style=color:#f92672>/</span>data<span style=color:#f92672>/</span>backups<span style=color:#f92672>/</span> <span style=color:#f92672>/</span>Storage<span style=color:#f92672>/</span>docker<span style=color:#f92672>/</span>custom_dev_gitlab<span style=color:#f92672>/</span>data<span style=color:#f92672>/</span>backups<span style=color:#f92672>/</span>
</span></span></code></pre></div></li><li><p>백업파일 권한 부여</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>chown 998:0 <span style=color:#f92672>/</span>Storage<span style=color:#f92672>/</span>docker<span style=color:#f92672>/</span>custom_dev_gitlab<span style=color:#f92672>/</span>data<span style=color:#f92672>/</span>backups<span style=color:#f92672>/</span>1671738795_2022_12_23_11.<span style=color:#a6e22e>10</span>.<span style=color:#a6e22e>8_gitlab_backup</span>.<span style=color:#a6e22e>tar</span>
</span></span></code></pre></div></li><li><p>복구 진행</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span> 호스트에서 gitlab<span style=color:#f92672>-</span>ce docker 쉘 진입
</span></span><span style=display:flex><span>docker exec <span style=color:#f92672>-</span>it custom_dev_gitlab <span style=color:#f92672>/</span>bin<span style=color:#f92672>/</span>bash
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span> gitlab<span style=color:#f92672>-</span>ce docker 쉘에서 진행
</span></span><span style=display:flex><span>gitlab<span style=color:#f92672>-</span>ctl stop unicorn <span style=color:#960050;background-color:#1e0010>#</span> 웹서비스가 puma 인 경우에는 puma
</span></span><span style=display:flex><span>gitlab<span style=color:#f92672>-</span>ctl stop sidekiq
</span></span><span style=display:flex><span>gitlab<span style=color:#f92672>-</span>rake gitlab:backup:restore BACKUP<span style=color:#f92672>=/</span>var<span style=color:#f92672>/</span>opt<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>backups<span style=color:#f92672>/</span>1671738795_2022_12_23_11.<span style=color:#a6e22e>10</span>.<span style=color:#a6e22e>8</span>
</span></span><span style=display:flex><span>Unpacking backup ... done
</span></span><span style=display:flex><span>Before restoring the database, we will remove all existing
</span></span><span style=display:flex><span>tables to avoid future upgrade problems. Be aware that <span style=color:#66d9ef>if</span> you have
</span></span><span style=display:flex><span>custom tables in the GitLab database these tables and all data will be
</span></span><span style=display:flex><span>removed.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Do you want to <span style=color:#a6e22e>continue</span> (yes<span style=color:#f92672>/</span>no)<span style=color:#f92672>?</span> yes
</span></span><span style=display:flex><span>Removing all tables. Press <span style=color:#960050;background-color:#1e0010>`</span>Ctrl<span style=color:#f92672>-</span>C<span style=color:#960050;background-color:#1e0010>`</span> within 5 seconds to abort
</span></span><span style=display:flex><span>2022<span style=color:#f92672>-</span>12<span style=color:#f92672>-</span>15 14:07:17 <span style=color:#f92672>+</span>0900 <span style=color:#f92672>--</span> Cleaning the database ...
</span></span><span style=display:flex><span>2022<span style=color:#f92672>-</span>12<span style=color:#f92672>-</span>15 14:07:21 <span style=color:#f92672>+</span>0900 <span style=color:#f92672>--</span> done
</span></span><span style=display:flex><span>2022<span style=color:#f92672>-</span>12<span style=color:#f92672>-</span>15 14:07:21 <span style=color:#f92672>+</span>0900 <span style=color:#f92672>--</span> Restoring database ...
</span></span><span style=display:flex><span>Restoring PostgreSQL database gitlabhq_production ...
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>2023<span style=color:#f92672>-</span>02<span style=color:#f92672>-</span>05 11:46:02 <span style=color:#f92672>+</span>0900 <span style=color:#f92672>--</span> Restoring lfs objects ...
</span></span><span style=display:flex><span>2023<span style=color:#f92672>-</span>02<span style=color:#f92672>-</span>05 11:46:04 <span style=color:#f92672>+</span>0900 <span style=color:#f92672>--</span> done
</span></span><span style=display:flex><span>This task will now rebuild the authorized_keys file.
</span></span><span style=display:flex><span>You will lose any data stored in the authorized_keys file.
</span></span><span style=display:flex><span>Do you want to <span style=color:#a6e22e>continue</span> (yes<span style=color:#f92672>/</span>no)<span style=color:#f92672>?</span>yes
</span></span></code></pre></div></li><li><p>Gitlab 서비스 재시작</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span> gitlab<span style=color:#f92672>-</span>ce docker 쉘에서 진행
</span></span><span style=display:flex><span>gitlab<span style=color:#f92672>-</span>ctl restart
</span></span></code></pre></div><ul><li>Admin 패스워드 변경</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span> gitlab<span style=color:#f92672>-</span>ce docker 쉘에서 진행
</span></span><span style=display:flex><span>gitlab<span style=color:#f92672>-</span>rails console
</span></span><span style=display:flex><span><span style=color:#f92672>-------------------------------------------------------------------------------------</span>
</span></span><span style=display:flex><span> GitLab:       11.<span style=color:#a6e22e>10</span>.<span style=color:#a6e22e>8</span> (313bd8e65df)
</span></span><span style=display:flex><span> GitLab Shell: 9.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>0</span>
</span></span><span style=display:flex><span> PostgreSQL:   9.<span style=color:#a6e22e>6</span>.<span style=color:#a6e22e>11</span>
</span></span><span style=display:flex><span><span style=color:#f92672>-------------------------------------------------------------------------------------</span>
</span></span><span style=display:flex><span>Loading production <span style=color:#a6e22e>environment</span> (Rails 5.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>7</span>.<span style=color:#a6e22e>2</span>)
</span></span><span style=display:flex><span>irb(main):001:0<span style=color:#f92672>&gt;</span> user <span style=color:#f92672>=</span> User.<span style=color:#a6e22e>find</span>(1)
</span></span><span style=display:flex><span><span style=color:#f92672>=&gt;</span> <span style=color:#960050;background-color:#1e0010>#</span><span style=color:#f92672>&lt;</span>User id:1 <span style=color:#a6e22e>@administrator</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>irb(main):002:0<span style=color:#f92672>&gt;</span> new_password <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>&#39;</span>원하는 패스워드 설정<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#34;원하는 패스워드 설정&#34;</span>
</span></span><span style=display:flex><span>irb(main):003:0<span style=color:#f92672>&gt;</span> user.<span style=color:#a6e22e>password</span> <span style=color:#f92672>=</span> new_password
</span></span><span style=display:flex><span><span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#34;원하는 패스워드 설정&#34;</span>
</span></span><span style=display:flex><span>irb(main):004:0<span style=color:#f92672>&gt;</span> user.<span style=color:#a6e22e>password_confirmation</span> <span style=color:#f92672>=</span> new_password
</span></span><span style=display:flex><span><span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#34;원하는 패스워드 설정&#34;</span>
</span></span><span style=display:flex><span>irb(main):005:0<span style=color:#f92672>&gt;</span> user.<span style=color:#a6e22e>save</span><span style=color:#f92672>!</span>
</span></span><span style=display:flex><span>Enqueued ActionMailer::DeliveryJob (Job ID: 1ac763a2<span style=color:#f92672>-</span>1672<span style=color:#f92672>-</span>4719<span style=color:#f92672>-</span>bc0c<span style=color:#f92672>-</span>1e1355ef35cc) to <span style=color:#a6e22e>Sidekiq</span>(mailers) with arguments: <span style=color:#e6db74>&#34;DeviseMailer&#34;</span>, <span style=color:#e6db74>&#34;password_change&#34;</span>, <span style=color:#e6db74>&#34;deliver_now&#34;</span>, <span style=color:#960050;background-color:#1e0010>#</span><span style=color:#f92672>&lt;</span>GlobalID:0x00007fd1f81f4d80 <span style=color:#a6e22e>@uri</span><span style=color:#f92672>=</span><span style=color:#960050;background-color:#1e0010>#</span><span style=color:#f92672>&lt;</span>URI::GID gid:<span style=color:#75715e>//gitlab/User/1&gt;&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>irb</span>(main):006:0<span style=color:#f92672>&gt;</span>exit
</span></span></code></pre></div></li></ul><blockquote><p>11.11.0-ce.0 업그레이드</p></blockquote><ul><li><p>docker-compose.yml 이미지 변경</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>services:
</span></span><span style=display:flex><span>  web:
</span></span><span style=display:flex><span>    image: <span style=color:#960050;background-color:#1e0010>&#39;</span>gitlab<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>-</span>ce:11.<span style=color:#a6e22e>11</span>.<span style=color:#a6e22e>0</span><span style=color:#f92672>-</span>ce.<span style=color:#a6e22e>0</span><span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>    restart: always
</span></span><span style=display:flex><span>    hostname: <span style=color:#960050;background-color:#1e0010>&#39;</span>dev<span style=color:#f92672>-</span>gitlab<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>    container_name: custom_dev_gitlab
</span></span><span style=display:flex><span>    environment:
</span></span><span style=display:flex><span>      GITLAB_OMNIBUS_CONFIG: <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>#</span> Add any other gitlab.<span style=color:#a6e22e>rb</span> configuration here, each on its own line
</span></span><span style=display:flex><span>        external_url <span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>&lt;</span>http:<span style=color:#75715e>//182.114.70.81:32000&gt;&#39;</span>
</span></span><span style=display:flex><span>        gitlab_rails<span style=color:#f92672>[</span><span style=color:#960050;background-color:#1e0010>&#39;</span>gitlab_shell_ssh_port<span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> 8102
</span></span><span style=display:flex><span>        gitlab_rails<span style=color:#f92672>[</span><span style=color:#960050;background-color:#1e0010>&#39;</span>time_zone<span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>&#39;</span>Asia<span style=color:#f92672>/</span>Seoul<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>    ports:
</span></span><span style=display:flex><span>      <span style=color:#f92672>-</span> <span style=color:#960050;background-color:#1e0010>&#39;</span>32000:32000<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>-</span> <span style=color:#960050;background-color:#1e0010>&#39;</span>8102:22<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>    volumes:
</span></span><span style=display:flex><span>      <span style=color:#f92672>-</span> <span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>/</span>Image<span style=color:#f92672>/</span>custom_dev_gitlab<span style=color:#f92672>/</span>config:<span style=color:#f92672>/</span>etc<span style=color:#f92672>/</span>gitlab<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>-</span> <span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>/</span>Image<span style=color:#f92672>/</span>custom_dev_gitlab<span style=color:#f92672>/</span>logs:<span style=color:#f92672>/</span>var<span style=color:#f92672>/</span>log<span style=color:#f92672>/</span>gitlab<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>-</span> <span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>/</span>Image<span style=color:#f92672>/</span>custom_dev_gitlab<span style=color:#f92672>/</span>data:<span style=color:#f92672>/</span>var<span style=color:#f92672>/</span>opt<span style=color:#f92672>/</span>gitlab<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>-</span> <span style=color:#f92672>/</span>etc<span style=color:#f92672>/</span>localtime:<span style=color:#f92672>/</span>etc<span style=color:#f92672>/</span>localtime:ro
</span></span></code></pre></div></li><li><p>Docker Compose 재시작</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>docker compose down
</span></span><span style=display:flex><span>docker compose up <span style=color:#f92672>-</span>d
</span></span></code></pre></div></li><li><p>Gitlab 컨테이너 로그 확인</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>docker logs <span style=color:#f92672>-</span>f custom_dev_gitlab
</span></span></code></pre></div></li></ul><blockquote><p>11.11.8-ce.0 업그레이드</p></blockquote><ul><li><p>docker-compose.yml 이미지 변경 후 11.11.0-ce.0 업그레이드와 동일한 방법으로 진행</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>...
</span></span><span style=display:flex><span>    image: <span style=color:#960050;background-color:#1e0010>&#39;</span>gitlab<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>-</span>ce:11.<span style=color:#a6e22e>11</span>.<span style=color:#a6e22e>8</span><span style=color:#f92672>-</span>ce.<span style=color:#a6e22e>0</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>**</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div></li></ul><blockquote><p>12.0.12-ce.0 업그레이드</p></blockquote><ul><li><p>docker-compose.yml 이미지 변경 후 11.11.0-ce.0 업그레이드와 동일한 방법으로 진행</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>...
</span></span><span style=display:flex><span>    image: <span style=color:#960050;background-color:#1e0010>&#39;</span>gitlab<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>-</span>ce:12.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>12</span><span style=color:#f92672>-</span>ce.<span style=color:#a6e22e>0</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>**</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div></li></ul><blockquote><p>12.1.17-ce.0 업그레이드</p></blockquote><ul><li><p>docker-compose.yml 이미지 변경 후 11.11.0-ce.0 업그레이드와 동일한 방법으로 진행</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>...
</span></span><span style=display:flex><span>    image: <span style=color:#960050;background-color:#1e0010>&#39;</span>gitlab<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>-</span>ce:12.<span style=color:#a6e22e>1</span>.<span style=color:#a6e22e>17</span><span style=color:#f92672>-</span>ce.<span style=color:#a6e22e>0</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>**</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div></li></ul><blockquote><p>12.10.14-ce.0 업그레이드</p></blockquote><ul><li><p>docker-compose.yml 이미지 변경 후 11.11.0-ce.0 업그레이드와 동일한 방법으로 진행</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>...
</span></span><span style=display:flex><span>    image: <span style=color:#960050;background-color:#1e0010>&#39;</span>gitlab<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>-</span>ce:12.<span style=color:#a6e22e>10</span>.<span style=color:#a6e22e>14</span><span style=color:#f92672>-</span>ce.<span style=color:#a6e22e>0</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>**</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div></li></ul><blockquote><p>13.0.14-ce.0 업그레이드</p></blockquote><ul><li><p>docker-compose.yml 이미지 변경 후 11.11.0-ce.0 업그레이드와 동일한 방법으로 진행</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>...
</span></span><span style=display:flex><span>    image: <span style=color:#960050;background-color:#1e0010>&#39;</span>gitlab<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>-</span>ce:13.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>14</span><span style=color:#f92672>-</span>ce.<span style=color:#a6e22e>0</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>**</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div></li></ul><blockquote><p>13.1.11-ce.0 업그레이드</p></blockquote><ul><li><p>docker-compose.yml 이미지 변경 후 11.11.0-ce.0 업그레이드와 동일한 방법으로 진행</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>...
</span></span><span style=display:flex><span>    image: <span style=color:#960050;background-color:#1e0010>&#39;</span>gitlab<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>-</span>ce:13.<span style=color:#a6e22e>1</span>.<span style=color:#a6e22e>11</span><span style=color:#f92672>-</span>ce.<span style=color:#a6e22e>0</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>**</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div></li></ul><blockquote><p>13.8.8-ce.0 업그레이드</p></blockquote><ul><li><p>docker-compose.yml 이미지 변경 후 11.11.0-ce.0 업그레이드와 동일한 방법으로 진행</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>...
</span></span><span style=display:flex><span>    image: <span style=color:#960050;background-color:#1e0010>&#39;</span>gitlab<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>-</span>ce:13.<span style=color:#a6e22e>8</span>.<span style=color:#a6e22e>8</span><span style=color:#f92672>-</span>ce.<span style=color:#a6e22e>0</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>**</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div></li></ul><blockquote><p>13.12.15-ce.0 업그레이드</p></blockquote><p>반드시 이전 단계에서 legacy storage를 hashed storage 로 변경 후 진행</p><ul><li><p>docker-compose.yml 이미지 변경</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>...
</span></span><span style=display:flex><span>    image: <span style=color:#960050;background-color:#1e0010>&#39;</span>gitlab<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>-</span>ce:13.<span style=color:#a6e22e>12</span>.<span style=color:#a6e22e>15</span><span style=color:#f92672>-</span>ce.<span style=color:#a6e22e>0</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>**</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div></li><li><p>Gitlab console에 진입하여 read-only 상태인 프로젝트들의 read-only 상태 해제</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span> 호스트에서 gitlab<span style=color:#f92672>-</span>ce docker 쉘 진입
</span></span><span style=display:flex><span>docker exec <span style=color:#f92672>-</span>it custom_dev_gitlab <span style=color:#f92672>/</span>bin<span style=color:#f92672>/</span>bash
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span> Gitlab consoe 진입
</span></span><span style=display:flex><span>gitlab<span style=color:#f92672>-</span>rails console
</span></span><span style=display:flex><span><span style=color:#f92672>--------------------------------------------------------------------------------</span>
</span></span><span style=display:flex><span> Ruby:         ruby 2.<span style=color:#a6e22e>7</span>.<span style=color:#a6e22e>2p137</span> (2020<span style=color:#f92672>-</span>10<span style=color:#f92672>-</span>01 revision 5445e04352) <span style=color:#f92672>[</span>x86_64<span style=color:#f92672>-</span>linux<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span> GitLab:       13.<span style=color:#a6e22e>12</span>.<span style=color:#a6e22e>15</span> (6614e1562c6) FOSS
</span></span><span style=display:flex><span> GitLab Shell: 13.<span style=color:#a6e22e>18</span>.<span style=color:#a6e22e>1</span>
</span></span><span style=display:flex><span> PostgreSQL:   12.<span style=color:#a6e22e>6</span>
</span></span><span style=display:flex><span><span style=color:#f92672>--------------------------------------------------------------------------------</span>
</span></span><span style=display:flex><span>Loading production <span style=color:#a6e22e>environment</span> (Rails 6.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>3</span>.<span style=color:#a6e22e>7</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span> 프로젝트들 중에서 read only프로젝트가 true인 레포가 있다면 하단 업데이트 진행
</span></span><span style=display:flex><span>projects <span style=color:#f92672>=</span> Project.<span style=color:#a6e22e>where</span>(repository_read_only: <span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>projects.<span style=color:#a6e22e>each</span> <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>p<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>  print p
</span></span><span style=display:flex><span>end
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span> read<span style=color:#f92672>-</span>only 상태인 프로젝트들의 read<span style=color:#f92672>-</span>only 상태 해제, end까지 한번에 복사해서 붙여넣기후 실행
</span></span><span style=display:flex><span>projects <span style=color:#f92672>=</span> Project.<span style=color:#a6e22e>where</span>(repository_read_only: <span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>projects.<span style=color:#a6e22e>each</span> <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>p<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>  p.<span style=color:#a6e22e>update</span><span style=color:#f92672>!</span>(repository_read_only:nil)
</span></span><span style=display:flex><span>end
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span> console 빠져나오기
</span></span><span style=display:flex><span>exit
</span></span></code></pre></div><p>하단처럼 read only로 되어 있는거 나옴</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>=&gt;</span> <span style=color:#f92672>[</span><span style=color:#960050;background-color:#1e0010>#</span><span style=color:#f92672>&lt;</span>Project id:363 codex<span style=color:#f92672>/</span>stamper<span style=color:#f92672>-</span>go<span style=color:#f92672>&gt;&gt;</span>, <span style=color:#960050;background-color:#1e0010>#</span><span style=color:#f92672>&lt;</span>Project id:364 jellywing<span style=color:#f92672>/</span>stamper<span style=color:#f92672>-</span>go<span style=color:#f92672>&gt;&gt;</span>, <span style=color:#960050;background-color:#1e0010>#</span><span style=color:#f92672>&lt;</span>Project id:367 dev<span style=color:#f92672>-</span>subbuilder<span style=color:#f92672>-</span>go<span style=color:#f92672>/</span>service<span style=color:#f92672>-</span>registry<span style=color:#f92672>&gt;&gt;</span>, <span style=color:#960050;background-color:#1e0010>#</span><span style=color:#f92672>&lt;</span>Project id:31 dev<span style=color:#f92672>-</span>rankup<span style=color:#f92672>-</span>vex<span style=color:#f92672>/</span>dev<span style=color:#f92672>-</span>rankup<span style=color:#f92672>-</span><span style=color:#66d9ef>public</span><span style=color:#f92672>/</span>rankup<span style=color:#f92672>-</span>console<span style=color:#f92672>&gt;&gt;]</span>
</span></span></code></pre></div><p>그렇게 해도 해싱 되지 않아서 안나오는레포들이있어서 하단 명령어 실행 하여 전부 조회</p><p>만약 레포에 들어갔는데 빈 레포로 나오면 하단의 작업 반드시 수행</p><ul><li><p>Before upgrade to 14.x, Prerequisites 반드시 하단의 링크로 들어가서 주의사항 정독!!!</p><p><a href=https://docs.gitlab.com/ee/update/#1400 target=_blank rel=noopener>Upgrading GitLab | GitLab</a></p><ul><li><p>migrating <a href=https://docs.gitlab.com/ee/administration/raketasks/storage.html#migrate-to-hashed-storage target=_blank rel=noopener>to hashed storage</a></p><p>13.8.8 에서 완료</p><p>만약 해싱이 안되어 있으면, <code>gitlab-rake gitlab:check SANITIZE=true</code> 이 단계에서 확인 가능</p></li><li><p>migrating <a href=https://docs.gitlab.com/ee/administration/operations/puma.html target=_blank rel=noopener>to Puma</a></p><p>하단 처럼 상태에 puma가 돌고 있으면 문제 없지만,안전하게 업그레이드 하기 위해 gitlab.rb에서 puma 설정을 enable 로 바꾼후 gitlab-ctl reconfigure 실행</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>gitlab<span style=color:#f92672>-</span>ctl status
</span></span><span style=display:flex><span>run: alertmanager: (pid 1595) 335s; run: log: (pid 1296) 358s
</span></span><span style=display:flex><span>run: gitaly: (pid 1471) 336s; run: log: (pid 535) 442s
</span></span><span style=display:flex><span>run: gitlab<span style=color:#f92672>-</span>exporter: (pid 1470) 336s; run: log: (pid 1109) 376s
</span></span><span style=display:flex><span>run: gitlab<span style=color:#f92672>-</span>workhorse: (pid 1436) 337s; run: log: (pid 824) 388s
</span></span><span style=display:flex><span>run: grafana: (pid 1622) 334s; run: log: (pid 1387) 346s
</span></span><span style=display:flex><span>run: logrotate: (pid 442) 457s; run: log: (pid 450) 456s
</span></span><span style=display:flex><span>run: nginx: (pid 830) 385s; run: log: (pid 857) 382s
</span></span><span style=display:flex><span>run: postgres<span style=color:#f92672>-</span>exporter: (pid 1613) 334s; run: log: (pid 1338) 352s
</span></span><span style=display:flex><span>run: postgresql: (pid 614) 439s; run: log: (pid 625) 438s
</span></span><span style=display:flex><span>run: prometheus: (pid 1568) 336s; run: log: (pid 1261) 364s
</span></span><span style=display:flex><span>run: puma: (pid 742) 403s; run: log: (pid 749) 402s
</span></span><span style=display:flex><span>run: redis: (pid 454) 451s; run: log: (pid 462) 449s
</span></span><span style=display:flex><span>run: redis<span style=color:#f92672>-</span>exporter: (pid 1481) 336s; run: log: (pid 1184) 370s
</span></span><span style=display:flex><span>run: sidekiq: (pid 756) 397s; run: log: (pid 767) 395s
</span></span><span style=display:flex><span>run: sshd: (pid 31) 467s; run: log: (pid 30) 467s
</span></span></code></pre></div></li></ul></li></ul></li></ul><blockquote><p>14.0.12-ce.0 업그레이드</p></blockquote><ul><li><p>docker-compose.yml 이미지 변경</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>...
</span></span><span style=display:flex><span>    image: <span style=color:#960050;background-color:#1e0010>&#39;</span>gitlab<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>-</span>ce:14.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>12</span><span style=color:#f92672>-</span>ce.<span style=color:#a6e22e>0</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>**</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div></li><li><p>unicorn 에 해당되는 부분들 주석 처리</p><p><code>vi /Storage/docker/custom_dev_gitlab/config/gitlab.rb</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span> unicorn<span style=color:#f92672>[</span><span style=color:#960050;background-color:#1e0010>&#39;</span>enable<span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span> 그외에도 unicorn 관련된 부분 모두 주석 처리
</span></span></code></pre></div></li><li><p>puma 활성화</p><p><code>vi /Storage/docker/custom_dev_gitlab/config/gitlab.rb</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>puma<span style=color:#f92672>[</span><span style=color:#960050;background-color:#1e0010>&#39;</span>enable<span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span></code></pre></div></li><li><p>Docker Compose 재시작</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>docker compose down
</span></span><span style=display:flex><span>docker compose up <span style=color:#f92672>-</span>d
</span></span></code></pre></div></li><li><p>Gitlab 컨테이너 로그 확인</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>docker logs <span style=color:#f92672>-</span>f custom_dev_gitlab
</span></span></code></pre></div></li><li><p>Issue</p><ul><li><p>웹페이지 표시 불가 및 에러 로그</p><p>이전 14버전으로 넘어오기전 13버전 마지막 즈음에서 hashed storage로 변환이 이루어지지 않아서 발생</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>https_test_gitlab  <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>https_test_gitlab  <span style=color:#f92672>|</span> Running handlers:
</span></span><span style=display:flex><span>https_test_gitlab  <span style=color:#f92672>|</span> Running handlers complete
</span></span><span style=display:flex><span>https_test_gitlab  <span style=color:#f92672>|</span> Chef Infra Client finished, 316<span style=color:#f92672>/</span>1392 resources updated in 01 minutes 33 seconds
</span></span><span style=display:flex><span>https_test_gitlab  <span style=color:#f92672>|</span> gitlab Reconfigured<span style=color:#f92672>!</span>
</span></span><span style=display:flex><span>https_test_gitlab  <span style=color:#f92672>|</span> Checking <span style=color:#66d9ef>for</span> unmigrated data on legacy storage
</span></span><span style=display:flex><span>https_test_gitlab  <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>https_test_gitlab  <span style=color:#f92672>|</span> Legacy storage is no longer supported. Please migrate your data to hashed storage.
</span></span><span style=display:flex><span>https_test_gitlab  <span style=color:#f92672>|</span> Check <span style=color:#f92672>&lt;</span>https:<span style=color:#75715e>//docs.gitlab.com/ee/administration/raketasks/storage.html#migrate-to-hashed-storage&gt; for details.</span>
</span></span><span style=display:flex><span>https_test_gitlab  <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>https_test_gitlab  <span style=color:#f92672>|</span> Upgrade failed. Retry the upgrade after migrating your data to hashed storage.
</span></span></code></pre></div></li><li><p>무한 재시작</p><p>하단 처럼 계속해서 재시작 된다면, Gitlab 도커를 완전히 종료(docker compose down 후 시작)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Upgrade failed. Could not check <span style=color:#66d9ef>for</span> unmigrated data on legacy storage.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>If you would like to restart the instance without perfming <span style=color:#66d9ef>this</span> check
</span></span><span style=display:flex><span>check, add the following to your docker command:
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>e GITLAB_SKIP_UNMIGRATED_DATA_CHECK<span style=color:#f92672>=</span><span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Thank you <span style=color:#66d9ef>for</span> using GitLab Docker Image<span style=color:#f92672>!</span>
</span></span><span style=display:flex><span>Current version: gitlab<span style=color:#f92672>-</span>ce<span style=color:#f92672>=</span>14.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>12</span><span style=color:#f92672>-</span>ce.<span style=color:#a6e22e>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Configure GitLab <span style=color:#66d9ef>for</span> your system by editing <span style=color:#f92672>/</span>etc<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>gitlab.<span style=color:#a6e22e>rb</span> file
</span></span><span style=display:flex><span>And restart <span style=color:#66d9ef>this</span> container to reload settings.
</span></span><span style=display:flex><span>To <span style=color:#66d9ef>do</span> it use docker exec:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  docker exec <span style=color:#f92672>-</span>it gitlab editor <span style=color:#f92672>/</span>etc<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>gitlab.<span style=color:#a6e22e>rb</span>
</span></span><span style=display:flex><span>  docker restart gitlab
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>For a comprehensive list of configuration options please see the Omnibus GitLab readme
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;</span>https:<span style=color:#75715e>//gitlab.com/gitlab-org/omnibus-gitlab/blob/master/README.md&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>If <span style=color:#66d9ef>this</span> container fails to start due to permission problems <span style=color:#66d9ef>try</span> to fix it by executing:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  docker exec <span style=color:#f92672>-</span>it gitlab update<span style=color:#f92672>-</span>permissions
</span></span><span style=display:flex><span>  docker restart gitlab
</span></span></code></pre></div></li></ul></li></ul><blockquote><p>14.3.6-ce.0 업그레이드</p></blockquote><ul><li><p>docker-compose.yml 이미지 변경 후 11.11.0-ce.0 업그레이드와 동일한 방법으로 진행</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>...
</span></span><span style=display:flex><span>    image: <span style=color:#960050;background-color:#1e0010>&#39;</span>gitlab<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>-</span>ce:14.<span style=color:#a6e22e>3</span>.<span style=color:#a6e22e>6</span><span style=color:#f92672>-</span>ce.<span style=color:#a6e22e>0</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>**</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div></li></ul><blockquote><p>14.9.5-ce.0 업그레이드</p></blockquote><ul><li><p>docker-compose.yml 이미지 변경 후 11.11.0-ce.0 업그레이드와 동일한 방법으로 진행</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>...
</span></span><span style=display:flex><span>    image: <span style=color:#960050;background-color:#1e0010>&#39;</span>gitlab<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>-</span>ce:14.<span style=color:#a6e22e>9</span>.<span style=color:#a6e22e>5</span><span style=color:#f92672>-</span>ce.<span style=color:#a6e22e>0</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>**</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div></li></ul><blockquote><p>14.10.5-ce.0 업그레이드</p></blockquote><ul><li><p>docker-compose.yml 이미지 변경 후 11.11.0-ce.0 업그레이드와 동일한 방법으로 진행</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>...
</span></span><span style=display:flex><span>    image: <span style=color:#960050;background-color:#1e0010>&#39;</span>gitlab<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>-</span>ce:14.<span style=color:#a6e22e>10</span>.<span style=color:#a6e22e>5</span><span style=color:#f92672>-</span>ce.<span style=color:#a6e22e>0</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>**</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div></li></ul><blockquote><p>15.0.5-ce.0 업그레이드</p></blockquote><ul><li><p>docker-compose.yml 이미지 변경 후 11.11.0-ce.0 업그레이드와 동일한 방법으로 진행</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>...
</span></span><span style=display:flex><span>    image: <span style=color:#960050;background-color:#1e0010>&#39;</span>gitlab<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>-</span>ce:15.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>5</span><span style=color:#f92672>-</span>ce.<span style=color:#a6e22e>0</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>**</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div></li></ul><blockquote><p>15.1.6-ce.0 업그레이드</p></blockquote><ul><li><p>docker-compose.yml 이미지 변경 후 11.11.0-ce.0 업그레이드와 동일한 방법으로 진행</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>...
</span></span><span style=display:flex><span>    image: <span style=color:#960050;background-color:#1e0010>&#39;</span>gitlab<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>-</span>ce:15.<span style=color:#a6e22e>1</span>.<span style=color:#a6e22e>6</span><span style=color:#f92672>-</span>ce.<span style=color:#a6e22e>0</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>**</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div></li></ul><blockquote><p>15.4.6-ce.0 업그레이드</p></blockquote><ul><li><p>docker-compose.yml 이미지 변경 후 11.11.0-ce.0 업그레이드와 동일한 방법으로 진행</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>...
</span></span><span style=display:flex><span>    image: <span style=color:#960050;background-color:#1e0010>&#39;</span>gitlab<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>-</span>ce:15.<span style=color:#a6e22e>4</span>.<span style=color:#a6e22e>6</span><span style=color:#f92672>-</span>ce.<span style=color:#a6e22e>0</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>**</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div></li></ul><blockquote><p>15.9.0-ce.0 업그레이드</p></blockquote><ul><li><p>docker-compose.yml 이미지 변경 후 11.11.0-ce.0 업그레이드와 동일한 방법으로 진행</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>...
</span></span><span style=display:flex><span>    image: <span style=color:#960050;background-color:#1e0010>&#39;</span>gitlab<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>-</span>ce:15.<span style=color:#a6e22e>4</span>.<span style=color:#a6e22e>6</span><span style=color:#f92672>-</span>ce.<span style=color:#a6e22e>0</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>**</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>15.9.0 버전 까지 업그레이드를 마쳤다면, 이후 최신버전으로 업그레이드는 별도의 Upgrade Path를 준수할 필요 없습니다.</p></li></ul><p>업그레이드 과정에서 자주 발생하는 에러에 대해서는 하단의 Debug History 참고 부탁드립니다.</p><hr><h1 id=debug-history>Debug History</h1><ul><li>Jira Gitlab Integration</li></ul><h2 id=gitlab-jira-integration-issue>Gitlab Jira Integration Issue</h2><p>Vm에서서 구동중인 신규로 구축한 Gitlab의 15.9.0~15.9.3  까지의 의 Jira 연동 시도</p><ul><li>도메인 주소 변경(<a href=http://jira-test-ce.devlab.com/ target=_blank rel=noopener>jira-test-ce.devlab.com</a> → <a href=http://jira-ce.devlab.com/ target=_blank rel=noopener>jira-ce.devlab.com)</a>
도메인 주소가 길어진 경우 이유를 알 수 없으나 Jira에서 Gitlab도메인을 인증 불가</li><li>Gitlab에 Admin권한을 가진 계정이 반드시 Jira의 Admin계정과 일치
현재 Jira는 admin 을 사용중이며, Gitlab에서도 해당 계정으로 연동을 진행해야만 정상적으로 Jira에서 Oatuh 가능</li><li>Gitlab의 Network Inboud 규칙 추가
local host와 내/외부 접근 IP에 대한 규칙이 추가 되어 있어야 Jira에서 오는 API가 정상적으로 동작</li><li>Jira의 API Key Gitlab 중복 연동 불가
서로 다를 도메인과 VM에서 실행중인 Gitlab에 동일한 Jira의 API키를 연동하면 먼저 연결한 쪽은 문제가 없지만, 나중에 연결한 Gitlab은 namespace인식을 못 함</li><li>연동시에 사용하는 포트 이슈<ul><li>443 Port 반드시 오픈
VM에서 신규로 구축한 Gitlab 을 연동할 때에는 443포트만 오픈 하여도 문제없이 연동이 되었지만, 현재 사내에서 운영중인 Gitlab서버에 동일한 설정후 연동을 진행 하려고 하면 문제 발생.
차이점은 VM은 any:any 방식으로 NAT 연결, Gitlab server는 포트 포워딩 방식으로 연결되어 있음</li></ul></li><li>Jira Gitlab 연동 플러그인 에러<ul><li><p>Failed to update Gitlab version. Please try again.
하단의 그림처럼 버전을 업데이트 해야 한다는 에러 메세지가 나옴
최신버전(15.9.0 이상)의 Gitlab을 Container로 새로 구축해서 연동 해도 동일</p><p><img src=/posts/tools/sub-gitlab/gitlab-upgrade/images/image-20230412-022014.png alt=image-20230412-022014.png></p></li><li><p>Failed to load Jira Connect Application ID. Please try again.
OAuth 인증을 위해 Gitlab으로 이동시 하단의 화면처럼 에러 리턴</p><p><img src=/posts/tools/sub-gitlab/gitlab-upgrade/images/image-20230412-024054.png alt=image-20230412-024054.png></p></li></ul></li></ul><h2 id=git-upgrade-issue>Git Upgrade Issue</h2><blockquote><p>13.8.8 → 15.9.3 업그레이드 이슈 해결</p></blockquote><h3 id=registry-not-exist>Registry Not Exist</h3><p>새로운 Gitlab에서 해당 설정 disable 하고 재시작 후 복구 진행 시, Registry가 없다는 이유로 복구가 중단 됨
원인은 백업 파일을 생성한 Gitlab에는 Registry 설정이 없거나 비활성화 되어있는 상태에서 백업을 받았고, 새로운 Gitlab에서는 기본 설정으로 Registry 기능이 활성화 되어 있어서 복구 과정에서 상단과 같은 문제 발생</p><ul><li><p>해결 방법</p><p>원래는 config 의 gitlab.rb에서 해야 하지만 편의를 위해 도커 컴포즈 파일의 환경 설정 에서 적용</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>registry<span style=color:#f92672>[</span><span style=color:#960050;background-color:#1e0010>&#39;</span>enable<span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>
</span></span></code></pre></div></li></ul><h3 id=storage-hashing>storage Hashing</h3><p>해당 이슈가 해결 안되면 500 error 가 뜨거나, 무한 재부팅 이슈 발생</p><ul><li><p>해결 방법</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>All projects are in hashed storage<span style=color:#f92672>?</span> ... no
</span></span><span style=display:flex><span>    Try fixing it:
</span></span><span style=display:flex><span>    Please migrate all projects to hashed storage
</span></span><span style=display:flex><span>    as legacy storage is deprecated in 13.<span style=color:#a6e22e>0</span> and support will be removed in 14.<span style=color:#a6e22e>0</span>.
</span></span><span style=display:flex><span>    For more information see:
</span></span><span style=display:flex><span>    doc<span style=color:#f92672>/</span>administration<span style=color:#f92672>/</span>repository_storage_types.<span style=color:#a6e22e>md</span>
</span></span></code></pre></div><p>gitlab:check 에서 projects hashed storage 이슈 발생 <a href=https://docs.gitlab.com/ee/update/#upgrade-paths target=_blank rel=noopener>Gitlab-13.4.0 Upgrading Instruction</a> 에 따르면, 13.4.0 부터 모든 레포들을 반드시 Hashed Storage로 변환해야 함</p></li></ul><h3 id=readonly-project>readonly project</h3><p>Readonly Project로 설정 되고 나면, 해당 프로젝트에 어떠한 것도 업로드 할 수 없음
예를 들어, Push, MR, Issue등 아무것도 업로드/생성 불가</p><ul><li><p>해결 방법</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 호스트에서 gitlab-ce docker 쉘 진입</span>
</span></span><span style=display:flex><span>$ docker exec -it custom_dev_gitlab /bin/bash
</span></span><span style=display:flex><span><span style=color:#75715e># Gitlab consoe 진입</span>
</span></span><span style=display:flex><span>gitlab-rails console
</span></span><span style=display:flex><span>--------------------------------------------------------------------------------
</span></span><span style=display:flex><span>    Ruby:         ruby 2.7.2p137 <span style=color:#f92672>(</span>2020-10-01 revision 5445e04352<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>x86_64-linux<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    GitLab:       13.12.15 <span style=color:#f92672>(</span>6614e1562c6<span style=color:#f92672>)</span> FOSS
</span></span><span style=display:flex><span>    GitLab Shell: 13.18.1
</span></span><span style=display:flex><span>    PostgreSQL:   12.6
</span></span><span style=display:flex><span>--------------------------------------------------------------------------------
</span></span><span style=display:flex><span>Loading production environment <span style=color:#f92672>(</span>Rails 6.0.3.7<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 프로젝트들 중에서 read only프로젝트가 true인 레포가 있다면 하단 업데이트 진행</span>
</span></span><span style=display:flex><span>projects <span style=color:#f92672>=</span> Project.where<span style=color:#f92672>(</span>repository_read_only: true<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>projects.each <span style=color:#66d9ef>do</span> |p|
</span></span><span style=display:flex><span>    print p
</span></span><span style=display:flex><span>end
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># read-only 상태인 프로젝트들의 read-only 상태 해제, end까지 한번에 복사해서 붙여넣기후 실행</span>
</span></span><span style=display:flex><span>projects <span style=color:#f92672>=</span> Project.where<span style=color:#f92672>(</span>repository_read_only: true<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>projects.each <span style=color:#66d9ef>do</span> |p|
</span></span><span style=display:flex><span>    p.update!<span style=color:#f92672>(</span>repository_read_only:nil<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>end
</span></span><span style=display:flex><span><span style=color:#75715e># console 빠져나오기</span>
</span></span><span style=display:flex><span>exit
</span></span></code></pre></div></li></ul><h3 id=service-not-enable>service not enable</h3><p>puma service 활성화를 안하면 Background migration 부분에서 <strong>무한 루프</strong></p><ul><li><p>해결 방법</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>gitlab<span style=color:#f92672>-</span>ctl status
</span></span><span style=display:flex><span>run: alertmanager: (pid 1595) 335s; run: log: (pid 1296) 358s
</span></span><span style=display:flex><span>run: gitaly: (pid 1471) 336s; run: log: (pid 535) 442s
</span></span><span style=display:flex><span>run: gitlab<span style=color:#f92672>-</span>exporter: (pid 1470) 336s; run: log: (pid 1109) 376s
</span></span><span style=display:flex><span>run: gitlab<span style=color:#f92672>-</span>workhorse: (pid 1436) 337s; run: log: (pid 824) 388s
</span></span><span style=display:flex><span>run: grafana: (pid 1622) 334s; run: log: (pid 1387) 346s
</span></span><span style=display:flex><span>run: logrotate: (pid 442) 457s; run: log: (pid 450) 456s
</span></span><span style=display:flex><span>run: nginx: (pid 830) 385s; run: log: (pid 857) 382s
</span></span><span style=display:flex><span>run: postgres<span style=color:#f92672>-</span>exporter: (pid 1613) 334s; run: log: (pid 1338) 352s
</span></span><span style=display:flex><span>run: postgresql: (pid 614) 439s; run: log: (pid 625) 438s
</span></span><span style=display:flex><span>run: prometheus: (pid 1568) 336s; run: log: (pid 1261) 364s
</span></span><span style=display:flex><span>run: puma: (pid 742) 403s; run: log: (pid 749) 402s
</span></span><span style=display:flex><span>run: redis: (pid 454) 451s; run: log: (pid 462) 449s
</span></span><span style=display:flex><span>run: redis<span style=color:#f92672>-</span>exporter: (pid 1481) 336s; run: log: (pid 1184) 370s
</span></span><span style=display:flex><span>run: sidekiq: (pid 756) 397s; run: log: (pid 767) 395s
</span></span><span style=display:flex><span>run: sshd: (pid 31) 467s; run: log: (pid 30) 467
</span></span></code></pre></div></li></ul><h3 id=db-error>DB Error</h3><p>Postgresql의 마이그레이션시 발생하는 이슈가 해결 안되면 <strong>유저 등록 불가, 특정 페이지 접근 불가, 프로젝트 생성 불가, 저장소 연결(push, clone…) 불가</strong> 이슈 발생</p><ul><li><p>해결 방법</p><p>하단의 쿼리를 Postgresql 에서 실행하여 이슈가 발생한 테이블 삭제 필요</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gitlabhq_production<span style=color:#f92672>=</span>&gt; DELETE FROM ci_group_variables;
</span></span><span style=display:flex><span>DELETE <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>gitlabhq_production<span style=color:#f92672>=</span>&gt; DELETE FROM ci_variables;
</span></span><span style=display:flex><span>DELETE <span style=color:#ae81ff>72</span>
</span></span><span style=display:flex><span>gitlabhq_production<span style=color:#f92672>=</span>&gt;
</span></span><span style=display:flex><span>gitlabhq_production<span style=color:#f92672>=</span>&gt; UPDATE projects SET runners_token <span style=color:#f92672>=</span> null, runners_token_encrypted <span style=color:#f92672>=</span> null;
</span></span><span style=display:flex><span>UPDATE <span style=color:#ae81ff>350</span>
</span></span><span style=display:flex><span>gitlabhq_production<span style=color:#f92672>=</span>&gt; UPDATE namespaces SET runners_token <span style=color:#f92672>=</span> null, runners_token_encrypted <span style=color:#f92672>=</span> null;
</span></span><span style=display:flex><span>UPDATE <span style=color:#ae81ff>198</span>
</span></span><span style=display:flex><span>gitlabhq_production<span style=color:#f92672>=</span>&gt; UPDATE application_settings SET runners_registration_token_encrypted <span style=color:#f92672>=</span> null;
</span></span><span style=display:flex><span>UPDATE <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>gitlabhq_production<span style=color:#f92672>=</span>&gt; UPDATE application_settings SET encrypted_ci_jwt_signing_key <span style=color:#f92672>=</span> null;
</span></span><span style=display:flex><span>UPDATE <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>gitlabhq_production<span style=color:#f92672>=</span>&gt; UPDATE ci_runners SET token <span style=color:#f92672>=</span> null, token_encrypted <span style=color:#f92672>=</span> null;
</span></span><span style=display:flex><span>UPDATE <span style=color:#ae81ff>81</span>
</span></span><span style=display:flex><span>gitlabhq_production<span style=color:#f92672>=</span>&gt;
</span></span><span style=display:flex><span>gitlabhq_production<span style=color:#f92672>=</span>&gt; UPDATE ci_builds SET token <span style=color:#f92672>=</span> null, token_encrypted <span style=color:#f92672>=</span> null;
</span></span><span style=display:flex><span>UPDATE <span style=color:#ae81ff>60857</span>
</span></span><span style=display:flex><span>gitlabhq_production<span style=color:#f92672>=</span>&gt;
</span></span><span style=display:flex><span>gitlabhq_production<span style=color:#f92672>=</span>&gt; TRUNCATE web_hooks CASCADE;
</span></span><span style=display:flex><span>NOTICE:  truncate cascades to table <span style=color:#e6db74>&#34;web_hook_logs&#34;</span>
</span></span><span style=display:flex><span>TRUNCATE TABLE
</span></span><span style=display:flex><span>gitlabhq_production<span style=color:#f92672>=</span>&gt;
</span></span><span style=display:flex><span>DELETE FROM ci_group_variables;
</span></span><span style=display:flex><span>DELETE FROM ci_variables;
</span></span><span style=display:flex><span>UPDATE projects SET runners_token <span style=color:#f92672>=</span> null, runners_token_encrypted <span style=color:#f92672>=</span> null;
</span></span><span style=display:flex><span>UPDATE namespaces SET runners_token <span style=color:#f92672>=</span> null, runners_token_encrypted <span style=color:#f92672>=</span> null;
</span></span><span style=display:flex><span>UPDATE application_settings SET runners_registration_token_encrypted <span style=color:#f92672>=</span> null;
</span></span><span style=display:flex><span>UPDATE ci_runners SET token <span style=color:#f92672>=</span> null, token_encrypted <span style=color:#f92672>=</span> null;
</span></span><span style=display:flex><span>UPDATE ci_builds SET token <span style=color:#f92672>=</span> null, token_encrypted <span style=color:#f92672>=</span> null;
</span></span><span style=display:flex><span>TRUNCATE web_hooks CASCADE;
</span></span><span style=display:flex><span>DELETE FROM application_settings;
</span></span></code></pre></div></li></ul><h3 id=projectimportdata-failures>ProjectImportData failures</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>[</span>2023<span style=color:#f92672>-</span>02<span style=color:#f92672>-</span>09T18:20:27.<span style=color:#a6e22e>909506</span> <span style=color:#960050;background-color:#1e0010>#</span>8920<span style=color:#f92672>]</span> INFO <span style=color:#f92672>--</span> : <span style=color:#f92672>-</span> ProjectImportData failures: 1
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>2023<span style=color:#f92672>-</span>02<span style=color:#f92672>-</span>09T18:20:27.<span style=color:#a6e22e>909587</span> <span style=color:#960050;background-color:#1e0010>#</span>8920<span style=color:#f92672>]</span> DEBUG <span style=color:#f92672>--</span> : <span style=color:#f92672>-</span> ProjectImportData<span style=color:#f92672>[</span>9<span style=color:#f92672>]</span>: credentials
</span></span></code></pre></div><p><a href=https://gitlab.com/gitlab-org/gitlab/-/issues/285080 target=_blank rel=noopener>https://gitlab.com/gitlab-org/gitlab/-/issues/285080</a></p><ul><li><p>해결 방법</p><p>하단의 예제는 credentials에 오류가 있는 컬럼을 찾아서 null 로 초기화 하는 코드</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ gitlab-rails c
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Find the ids of the corrupt ProjectImportData objects</span>
</span></span><span style=display:flex><span>    total <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    bad <span style=color:#f92672>=</span> <span style=color:#f92672>[]</span>
</span></span><span style=display:flex><span>    ProjectImportData.find_each <span style=color:#66d9ef>do</span> |data|
</span></span><span style=display:flex><span>    begin
</span></span><span style=display:flex><span>        total <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        data.credentials
</span></span><span style=display:flex><span>    rescue <span style=color:#f92672>=</span>&gt; e
</span></span><span style=display:flex><span>        bad <span style=color:#e6db74>&lt;&lt; data.id
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    end
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    end
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    puts &#34;Bad count: #{bad.count} / #{total}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    # See the bad ProjectImportData ids
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    bad
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    # Remove the corrupted credentials
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    import_data</span> <span style=color:#f92672>=</span> ProjectImportData.where<span style=color:#f92672>(</span>id: bad<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    import_data.each <span style=color:#66d9ef>do</span> |data|
</span></span><span style=display:flex><span>    data.update_columns<span style=color:#f92672>({</span> encrypted_credentials: nil, encrypted_credentials_iv: nil, encrypted_credentials_salt: nil<span style=color:#f92672>})</span>
</span></span><span style=display:flex><span>    end
</span></span></code></pre></div></li><li><p>예시</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>irb(main):001:0<span style=color:#f92672>&gt;</span>   total <span style=color:#f92672>=</span> 0
</span></span><span style=display:flex><span><span style=color:#f92672>=&gt;</span> 0
</span></span><span style=display:flex><span><span style=color:#a6e22e>irb</span>(main):002:0<span style=color:#f92672>&gt;</span>   bad <span style=color:#f92672>=</span> <span style=color:#f92672>[]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>=&gt;</span> <span style=color:#f92672>[]</span>
</span></span><span style=display:flex><span>irb(main):003:1<span style=color:#f92672>*</span>   ProjectImportData.<span style=color:#a6e22e>find_each</span> <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>data<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>irb(main):004:2<span style=color:#f92672>*</span>     begin
</span></span><span style=display:flex><span><span style=color:#a6e22e>irb</span>(main):005:2<span style=color:#f92672>*</span>       total <span style=color:#f92672>+=</span> 1
</span></span><span style=display:flex><span><span style=color:#a6e22e>irb</span>(main):006:2<span style=color:#f92672>*</span>       data.<span style=color:#a6e22e>credentials</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>irb</span>(main):007:2<span style=color:#f92672>*</span>     rescue <span style=color:#f92672>=&gt;</span> e
</span></span><span style=display:flex><span><span style=color:#a6e22e>irb</span>(main):008:2<span style=color:#f92672>*</span>       bad <span style=color:#f92672>&lt;&lt;</span> data.<span style=color:#a6e22e>id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>irb</span>(main):009:1<span style=color:#f92672>*</span>     end
</span></span><span style=display:flex><span><span style=color:#a6e22e>irb</span>(main):010:0<span style=color:#f92672>&gt;</span>   end
</span></span><span style=display:flex><span><span style=color:#f92672>=&gt;</span> nil
</span></span><span style=display:flex><span><span style=color:#a6e22e>irb</span>(main):011:0<span style=color:#f92672>&gt;</span> puts <span style=color:#e6db74>&#34;Bad count: #{bad.count} / #{total}&#34;</span>
</span></span><span style=display:flex><span>Bad count: 1 <span style=color:#f92672>/</span> 1
</span></span><span style=display:flex><span><span style=color:#f92672>=&gt;</span> nil
</span></span><span style=display:flex><span><span style=color:#a6e22e>irb</span>(main):012:0<span style=color:#f92672>&gt;</span> bad
</span></span><span style=display:flex><span><span style=color:#f92672>=&gt;</span> <span style=color:#f92672>[</span>9<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>irb</span>(main):013:0<span style=color:#f92672>&gt;</span> import_data <span style=color:#f92672>=</span> ProjectImportData.<span style=color:#a6e22e>where</span>(id: bad)
</span></span><span style=display:flex><span><span style=color:#f92672>=&gt;</span> <span style=color:#960050;background-color:#1e0010>#</span><span style=color:#f92672>&lt;</span>ActiveRecord::Relation <span style=color:#f92672>[</span><span style=color:#960050;background-color:#1e0010>#</span><span style=color:#f92672>&lt;</span>ProjectImportData id: 9, project_id: 28, data: nil, encrypted_credentials: <span style=color:#e6db74>&#34;bBpRdlKeY+/yggOwozgG7kLwOr7gjZxPk0MQQxWueLFO70WSwu...&#34;</span>, encrypted_credentials_iv: <span style=color:#e6db74>&#34;SA6wLgm6kdMQGLrk/Fq+kA==\\n&#34;</span>, encr...
</span></span><span style=display:flex><span><span style=color:#a6e22e>irb</span>(main):014:0<span style=color:#f92672>&gt;</span> iedentials_salt: nil})
</span></span><span style=display:flex><span>irb(main):014:1<span style=color:#f92672>*</span> import_data.<span style=color:#a6e22e>each</span> <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>data<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>irb(main):015:1<span style=color:#f92672>*</span>   data.<span style=color:#a6e22e>update_columns</span>({ encrypted_credentials: nil, encrypted_credentials_iv: nil, encrypted_credentials_salt: nil})
</span></span><span style=display:flex><span>irb(main):016:0<span style=color:#f92672>&gt;</span> end
</span></span><span style=display:flex><span><span style=color:#f92672>=&gt;</span> <span style=color:#f92672>[</span><span style=color:#960050;background-color:#1e0010>#</span><span style=color:#f92672>&lt;</span>ProjectImportData id: 9, project_id: 28, data: nil, encrypted_credentials: nil, encrypted_credentials_iv: nil, encrypted_credentials_salt: nil, credentials: nil<span style=color:#f92672>&gt;]</span>
</span></span></code></pre></div></li></ul><h3 id=fix-integrations-and-webhooks>Fix integrations and webhooks</h3><p>최신 버전의 가이드 → <a href=https://docs.gitlab.com/ee/raketasks/backup_restore.html#fix-integrations-and-webhooks target=_blank rel=noopener>Back up and restore GitLab | GitLab</a>
현재 버전의 가이드 → <a href=https://docs.gitlab.com/13.12/ee/raketasks/backup_restore.html#fix-project-integrations target=_blank rel=noopener>Back up and restore GitLab | GitLab</a></p><p>logs/gitlab-rails 에서 production.log 를 보면 하단과 같이 나옴</p><ul><li><p>Jira 연동 에러 Log</p><ul><li><p>해결 방법<br>하단의 쿼리 실행</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>gitlabhq_production<span style=color:#f92672>=&gt;</span> delete from jira_connect_installations;
</span></span><span style=display:flex><span>DELETE 1
</span></span><span style=display:flex><span>gitlabhq_production<span style=color:#f92672>=&gt;</span> delete from jira_connect_subscriptions;
</span></span><span style=display:flex><span>DELETE 0
</span></span><span style=display:flex><span>gitlabhq_production<span style=color:#f92672>=&gt;</span> delete from jira_imports;
</span></span><span style=display:flex><span>DELETE 0
</span></span><span style=display:flex><span>gitlabhq_production<span style=color:#f92672>=&gt;</span> delete from jira_tracker_data;
</span></span><span style=display:flex><span>DELETE 14
</span></span><span style=display:flex><span>gitlabhq_production<span style=color:#f92672>=&gt;</span>
</span></span></code></pre></div></li><li><p>Log</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Started GET <span style=color:#e6db74>&#34;/admin/runners&#34;</span> <span style=color:#66d9ef>for</span> 192.<span style=color:#a6e22e>168</span>.<span style=color:#a6e22e>200</span>.<span style=color:#a6e22e>1</span> at 2023<span style=color:#f92672>-</span>02<span style=color:#f92672>-</span>09 10:49:16 <span style=color:#f92672>+</span>0900
</span></span><span style=display:flex><span>Processing by Admin::RunnersController<span style=color:#960050;background-color:#1e0010>#</span>index as HTML
</span></span><span style=display:flex><span>Completed 500 Internal Server Error in <span style=color:#a6e22e>46ms</span> (ActiveRecord: 1.<span style=color:#a6e22e>5ms</span> <span style=color:#f92672>|</span> Elasticsearch: 0.<span style=color:#a6e22e>0ms</span> <span style=color:#f92672>|</span> Allocations: 51078)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ActionView::Template::Error ():
</span></span><span style=display:flex><span>    36:
</span></span><span style=display:flex><span>    37:   .<span style=color:#a6e22e>col</span><span style=color:#f92672>-</span>sm<span style=color:#f92672>-</span>6
</span></span><span style=display:flex><span>    38:     .<span style=color:#a6e22e>bs</span><span style=color:#f92672>-</span>callout
</span></span><span style=display:flex><span>    39:       <span style=color:#f92672>=</span> render partial: <span style=color:#960050;background-color:#1e0010>&#39;</span>ci<span style=color:#f92672>/</span>runner<span style=color:#f92672>/</span>how_to_setup_runner<span style=color:#960050;background-color:#1e0010>&#39;</span>,
</span></span><span style=display:flex><span>    40:                 locals: { registration_token: Gitlab::CurrentSettings.<span style=color:#a6e22e>runners_registration_token</span>,
</span></span><span style=display:flex><span>    41:                           type: <span style=color:#960050;background-color:#1e0010>&#39;</span>shared<span style=color:#960050;background-color:#1e0010>&#39;</span>,
</span></span><span style=display:flex><span>    42:                           reset_token_url: reset_registration_token_admin_application_settings_path }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>crypto_helper.<span style=color:#a6e22e>rb</span>:27:in <span style=color:#960050;background-color:#1e0010>`</span>aes256_gcm_decrypt<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>app<span style=color:#f92672>/</span>models<span style=color:#f92672>/</span>concerns<span style=color:#f92672>/</span>token_authenticatable_strategies<span style=color:#f92672>/</span>encrypted.<span style=color:#a6e22e>rb</span>:45:in <span style=color:#960050;background-color:#1e0010>`</span>get_token<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>app<span style=color:#f92672>/</span>models<span style=color:#f92672>/</span>concerns<span style=color:#f92672>/</span>token_authenticatable_strategies<span style=color:#f92672>/</span>base.<span style=color:#a6e22e>rb</span>:38:in <span style=color:#960050;background-color:#1e0010>`</span>ensure_token<span style=color:#f92672>!</span><span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>app<span style=color:#f92672>/</span>models<span style=color:#f92672>/</span>concerns<span style=color:#f92672>/</span>token_authenticatable.<span style=color:#a6e22e>rb</span>:48:in <span style=color:#960050;background-color:#1e0010>`</span>block in add_authentication_token_field<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>app<span style=color:#f92672>/</span>models<span style=color:#f92672>/</span>application_setting_implementation.<span style=color:#a6e22e>rb</span>:336:in <span style=color:#960050;background-color:#1e0010>`</span>runners_registration_token<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>current_settings.<span style=color:#a6e22e>rb</span>:20:in <span style=color:#960050;background-color:#1e0010>`</span>method_missing<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>app<span style=color:#f92672>/</span>views<span style=color:#f92672>/</span>admin<span style=color:#f92672>/</span>runners<span style=color:#f92672>/</span>index.<span style=color:#a6e22e>html</span>.<span style=color:#a6e22e>haml</span>:39
</span></span><span style=display:flex><span>app<span style=color:#f92672>/</span>controllers<span style=color:#f92672>/</span>application_controller.<span style=color:#a6e22e>rb</span>:125:in <span style=color:#960050;background-color:#1e0010>`</span>render<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>app<span style=color:#f92672>/</span>controllers<span style=color:#f92672>/</span>application_controller.<span style=color:#a6e22e>rb</span>:482:in <span style=color:#960050;background-color:#1e0010>`</span>set_current_admin<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>session.<span style=color:#a6e22e>rb</span>:11:in <span style=color:#960050;background-color:#1e0010>`</span>with_session<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>app<span style=color:#f92672>/</span>controllers<span style=color:#f92672>/</span>application_controller.<span style=color:#a6e22e>rb</span>:473:in <span style=color:#960050;background-color:#1e0010>`</span>set_session_storage<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>i18n.<span style=color:#a6e22e>rb</span>:73:in <span style=color:#960050;background-color:#1e0010>`</span>with_locale<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>i18n.<span style=color:#a6e22e>rb</span>:79:in <span style=color:#960050;background-color:#1e0010>`</span>with_user_locale<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>app<span style=color:#f92672>/</span>controllers<span style=color:#f92672>/</span>application_controller.<span style=color:#a6e22e>rb</span>:467:in <span style=color:#960050;background-color:#1e0010>`</span>set_locale<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>error_tracking.<span style=color:#a6e22e>rb</span>:52:in <span style=color:#960050;background-color:#1e0010>`</span>with_context<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>app<span style=color:#f92672>/</span>controllers<span style=color:#f92672>/</span>application_controller.<span style=color:#a6e22e>rb</span>:532:in <span style=color:#960050;background-color:#1e0010>`</span>sentry_context<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>app<span style=color:#f92672>/</span>controllers<span style=color:#f92672>/</span>application_controller.<span style=color:#a6e22e>rb</span>:460:in <span style=color:#960050;background-color:#1e0010>`</span>block in set_current_context<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>application_context.<span style=color:#a6e22e>rb</span>:56:in <span style=color:#960050;background-color:#1e0010>`</span>block in use<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>application_context.<span style=color:#a6e22e>rb</span>:56:in <span style=color:#960050;background-color:#1e0010>`</span>use<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>application_context.<span style=color:#a6e22e>rb</span>:22:in <span style=color:#960050;background-color:#1e0010>`</span>with_context<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>app<span style=color:#f92672>/</span>controllers<span style=color:#f92672>/</span>application_controller.<span style=color:#a6e22e>rb</span>:451:in <span style=color:#960050;background-color:#1e0010>`</span>set_current_context<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>metrics<span style=color:#f92672>/</span>elasticsearch_rack_middleware.<span style=color:#a6e22e>rb</span>:16:in <span style=color:#960050;background-color:#1e0010>`</span>call<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>middleware<span style=color:#f92672>/</span>rails_queue_duration.<span style=color:#a6e22e>rb</span>:33:in <span style=color:#960050;background-color:#1e0010>`</span>call<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>metrics<span style=color:#f92672>/</span>rack_middleware.<span style=color:#a6e22e>rb</span>:16:in <span style=color:#960050;background-color:#1e0010>`</span>block in call<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>metrics<span style=color:#f92672>/</span>transaction.<span style=color:#a6e22e>rb</span>:56:in <span style=color:#960050;background-color:#1e0010>`</span>run<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>metrics<span style=color:#f92672>/</span>rack_middleware.<span style=color:#a6e22e>rb</span>:16:in <span style=color:#960050;background-color:#1e0010>`</span>call<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>request_profiler<span style=color:#f92672>/</span>middleware.<span style=color:#a6e22e>rb</span>:17:in <span style=color:#960050;background-color:#1e0010>`</span>call<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>jira<span style=color:#f92672>/</span>middleware.<span style=color:#a6e22e>rb</span>:19:in <span style=color:#960050;background-color:#1e0010>`</span>call<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>middleware<span style=color:#f92672>/</span>go.<span style=color:#a6e22e>rb</span>:20:in <span style=color:#960050;background-color:#1e0010>`</span>call<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>etag_caching<span style=color:#f92672>/</span>middleware.<span style=color:#a6e22e>rb</span>:21:in <span style=color:#960050;background-color:#1e0010>`</span>call<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>middleware<span style=color:#f92672>/</span>multipart.<span style=color:#a6e22e>rb</span>:172:in <span style=color:#960050;background-color:#1e0010>`</span>call<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>middleware<span style=color:#f92672>/</span>read_only<span style=color:#f92672>/</span>controller.<span style=color:#a6e22e>rb</span>:50:in <span style=color:#960050;background-color:#1e0010>`</span>call<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>middleware<span style=color:#f92672>/</span>read_only.<span style=color:#a6e22e>rb</span>:18:in <span style=color:#960050;background-color:#1e0010>`</span>call<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>middleware<span style=color:#f92672>/</span>same_site_cookies.<span style=color:#a6e22e>rb</span>:27:in <span style=color:#960050;background-color:#1e0010>`</span>call<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>middleware<span style=color:#f92672>/</span>handle_malformed_strings.<span style=color:#a6e22e>rb</span>:21:in <span style=color:#960050;background-color:#1e0010>`</span>call<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>middleware<span style=color:#f92672>/</span>basic_health_check.<span style=color:#a6e22e>rb</span>:25:in <span style=color:#960050;background-color:#1e0010>`</span>call<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>middleware<span style=color:#f92672>/</span>handle_ip_spoof_attack_error.<span style=color:#a6e22e>rb</span>:25:in <span style=color:#960050;background-color:#1e0010>`</span>call<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>middleware<span style=color:#f92672>/</span>request_context.<span style=color:#a6e22e>rb</span>:23:in <span style=color:#960050;background-color:#1e0010>`</span>call<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>config<span style=color:#f92672>/</span>initializers<span style=color:#f92672>/</span>fix_local_cache_middleware.<span style=color:#a6e22e>rb</span>:9:in <span style=color:#960050;background-color:#1e0010>`</span>call<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>metrics<span style=color:#f92672>/</span>requests_rack_middleware.<span style=color:#a6e22e>rb</span>:76:in <span style=color:#960050;background-color:#1e0010>`</span>call<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>middleware<span style=color:#f92672>/</span>release_env.<span style=color:#a6e22e>rb</span>:12:in <span style=color:#960050;background-color:#1e0010>`</span>call<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span></code></pre></div></li></ul></li><li><p>web Hook 연동 에러</p><ul><li><p>Log</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Started GET <span style=color:#e6db74>&#34;/dev-rankup-vex/rankup/hooks&#34;</span> <span style=color:#66d9ef>for</span> 192.<span style=color:#a6e22e>168</span>.<span style=color:#a6e22e>200</span>.<span style=color:#a6e22e>1</span> at 2023<span style=color:#f92672>-</span>02<span style=color:#f92672>-</span>20 16:19:44 <span style=color:#f92672>+</span>0900
</span></span><span style=display:flex><span>Processing by Projects::HooksController<span style=color:#960050;background-color:#1e0010>#</span>index as HTML
</span></span><span style=display:flex><span>    Parameters: {<span style=color:#e6db74>&#34;namespace_id&#34;</span><span style=color:#f92672>=&gt;</span><span style=color:#e6db74>&#34;dev-rankup-vex&#34;</span>, <span style=color:#e6db74>&#34;project_id&#34;</span><span style=color:#f92672>=&gt;</span><span style=color:#e6db74>&#34;rankup&#34;</span>}
</span></span><span style=display:flex><span>Completed 500 Internal Server Error in <span style=color:#a6e22e>61ms</span> (ActiveRecord: 2.<span style=color:#a6e22e>7ms</span> <span style=color:#f92672>|</span> Elasticsearch: 0.<span style=color:#a6e22e>0ms</span> <span style=color:#f92672>|</span> Allocations: 66041)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ActionView::Template::Error ():
</span></span><span style=display:flex><span>    1: <span style=color:#f92672>%</span>li
</span></span><span style=display:flex><span>    2:   .<span style=color:#a6e22e>row</span>
</span></span><span style=display:flex><span>    3:     .<span style=color:#a6e22e>col</span><span style=color:#f92672>-</span>md<span style=color:#f92672>-</span>8.<span style=color:#a6e22e>col</span><span style=color:#f92672>-</span>lg<span style=color:#f92672>-</span>7
</span></span><span style=display:flex><span>    4:       <span style=color:#f92672>%</span>strong.<span style=color:#a6e22e>light</span><span style=color:#f92672>-</span>header<span style=color:#f92672>=</span> hook.<span style=color:#a6e22e>url</span>
</span></span><span style=display:flex><span>    5:       <span style=color:#f92672>%</span>div
</span></span><span style=display:flex><span>    6:         <span style=color:#f92672>-</span> hook.<span style=color:#a6e22e>class</span>.<span style=color:#a6e22e>triggers</span>.<span style=color:#a6e22e>each_value</span> <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>trigger<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>    7:           <span style=color:#f92672>-</span> <span style=color:#66d9ef>if</span> hook.<span style=color:#a6e22e>public_send</span>(trigger)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app<span style=color:#f92672>/</span>views<span style=color:#f92672>/</span>shared<span style=color:#f92672>/</span>web_hooks<span style=color:#f92672>/</span>_hook.<span style=color:#a6e22e>html</span>.<span style=color:#a6e22e>haml</span>:4
</span></span><span style=display:flex><span>app<span style=color:#f92672>/</span>views<span style=color:#f92672>/</span>shared<span style=color:#f92672>/</span>web_hooks<span style=color:#f92672>/</span>_index.<span style=color:#a6e22e>html</span>.<span style=color:#a6e22e>haml</span>:11
</span></span><span style=display:flex><span>app<span style=color:#f92672>/</span>views<span style=color:#f92672>/</span>shared<span style=color:#f92672>/</span>web_hooks<span style=color:#f92672>/</span>_index.<span style=color:#a6e22e>html</span>.<span style=color:#a6e22e>haml</span>:10
</span></span><span style=display:flex><span>app<span style=color:#f92672>/</span>views<span style=color:#f92672>/</span>projects<span style=color:#f92672>/</span>hooks<span style=color:#f92672>/</span>index.<span style=color:#a6e22e>html</span>.<span style=color:#a6e22e>haml</span>:14
</span></span><span style=display:flex><span>app<span style=color:#f92672>/</span>controllers<span style=color:#f92672>/</span>application_controller.<span style=color:#a6e22e>rb</span>:125:in <span style=color:#960050;background-color:#1e0010>`</span>render<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>app<span style=color:#f92672>/</span>controllers<span style=color:#f92672>/</span>application_controller.<span style=color:#a6e22e>rb</span>:482:in <span style=color:#960050;background-color:#1e0010>`</span>set_current_admin<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>session.<span style=color:#a6e22e>rb</span>:11:in <span style=color:#960050;background-color:#1e0010>`</span>with_session<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>app<span style=color:#f92672>/</span>controllers<span style=color:#f92672>/</span>application_controller.<span style=color:#a6e22e>rb</span>:473:in <span style=color:#960050;background-color:#1e0010>`</span>set_session_storage<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>i18n.<span style=color:#a6e22e>rb</span>:73:in <span style=color:#960050;background-color:#1e0010>`</span>with_locale<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>i18n.<span style=color:#a6e22e>rb</span>:79:in <span style=color:#960050;background-color:#1e0010>`</span>with_user_locale<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>app<span style=color:#f92672>/</span>controllers<span style=color:#f92672>/</span>application_controller.<span style=color:#a6e22e>rb</span>:467:in <span style=color:#960050;background-color:#1e0010>`</span>set_locale<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>error_tracking.<span style=color:#a6e22e>rb</span>:52:in <span style=color:#960050;background-color:#1e0010>`</span>with_context<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>app<span style=color:#f92672>/</span>controllers<span style=color:#f92672>/</span>application_controller.<span style=color:#a6e22e>rb</span>:532:in <span style=color:#960050;background-color:#1e0010>`</span>sentry_context<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>app<span style=color:#f92672>/</span>controllers<span style=color:#f92672>/</span>application_controller.<span style=color:#a6e22e>rb</span>:460:in <span style=color:#960050;background-color:#1e0010>`</span>block in set_current_context<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>application_context.<span style=color:#a6e22e>rb</span>:56:in <span style=color:#960050;background-color:#1e0010>`</span>block in use<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>application_context.<span style=color:#a6e22e>rb</span>:56:in <span style=color:#960050;background-color:#1e0010>`</span>use<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>application_context.<span style=color:#a6e22e>rb</span>:22:in <span style=color:#960050;background-color:#1e0010>`</span>with_context<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>app<span style=color:#f92672>/</span>controllers<span style=color:#f92672>/</span>application_controller.<span style=color:#a6e22e>rb</span>:451:in <span style=color:#960050;background-color:#1e0010>`</span>set_current_context<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>metrics<span style=color:#f92672>/</span>elasticsearch_rack_middleware.<span style=color:#a6e22e>rb</span>:16:in <span style=color:#960050;background-color:#1e0010>`</span>call<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>middleware<span style=color:#f92672>/</span>rails_queue_duration.<span style=color:#a6e22e>rb</span>:33:in <span style=color:#960050;background-color:#1e0010>`</span>call<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>metrics<span style=color:#f92672>/</span>rack_middleware.<span style=color:#a6e22e>rb</span>:16:in <span style=color:#960050;background-color:#1e0010>`</span>block in call<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>metrics<span style=color:#f92672>/</span>transaction.<span style=color:#a6e22e>rb</span>:56:in <span style=color:#960050;background-color:#1e0010>`</span>run<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>metrics<span style=color:#f92672>/</span>rack_middleware.<span style=color:#a6e22e>rb</span>:16:in <span style=color:#960050;background-color:#1e0010>`</span>call<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>request_profiler<span style=color:#f92672>/</span>middleware.<span style=color:#a6e22e>rb</span>:17:in <span style=color:#960050;background-color:#1e0010>`</span>call<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>jira<span style=color:#f92672>/</span>middleware.<span style=color:#a6e22e>rb</span>:19:in <span style=color:#960050;background-color:#1e0010>`</span>call<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>middleware<span style=color:#f92672>/</span>go.<span style=color:#a6e22e>rb</span>:20:in <span style=color:#960050;background-color:#1e0010>`</span>call<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>etag_caching<span style=color:#f92672>/</span>middleware.<span style=color:#a6e22e>rb</span>:21:in <span style=color:#960050;background-color:#1e0010>`</span>call<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>middleware<span style=color:#f92672>/</span>multipart.<span style=color:#a6e22e>rb</span>:172:in <span style=color:#960050;background-color:#1e0010>`</span>call<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>middleware<span style=color:#f92672>/</span>read_only<span style=color:#f92672>/</span>controller.<span style=color:#a6e22e>rb</span>:50:in <span style=color:#960050;background-color:#1e0010>`</span>call<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>middleware<span style=color:#f92672>/</span>read_only.<span style=color:#a6e22e>rb</span>:18:in <span style=color:#960050;background-color:#1e0010>`</span>call<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>middleware<span style=color:#f92672>/</span>same_site_cookies.<span style=color:#a6e22e>rb</span>:27:in <span style=color:#960050;background-color:#1e0010>`</span>call<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>middleware<span style=color:#f92672>/</span>handle_malformed_strings.<span style=color:#a6e22e>rb</span>:21:in <span style=color:#960050;background-color:#1e0010>`</span>call<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>middleware<span style=color:#f92672>/</span>basic_health_check.<span style=color:#a6e22e>rb</span>:25:in <span style=color:#960050;background-color:#1e0010>`</span>call<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>middleware<span style=color:#f92672>/</span>handle_ip_spoof_attack_error.<span style=color:#a6e22e>rb</span>:25:in <span style=color:#960050;background-color:#1e0010>`</span>call<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>middleware<span style=color:#f92672>/</span>request_context.<span style=color:#a6e22e>rb</span>:23:in <span style=color:#960050;background-color:#1e0010>`</span>call<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>config<span style=color:#f92672>/</span>initializers<span style=color:#f92672>/</span>fix_local_cache_middleware.<span style=color:#a6e22e>rb</span>:9:in <span style=color:#960050;background-color:#1e0010>`</span>call<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>metrics<span style=color:#f92672>/</span>requests_rack_middleware.<span style=color:#a6e22e>rb</span>:76:in <span style=color:#960050;background-color:#1e0010>`</span>call<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>lib<span style=color:#f92672>/</span>gitlab<span style=color:#f92672>/</span>middleware<span style=color:#f92672>/</span>release_env.<span style=color:#a6e22e>rb</span>:12:in <span style=color:#960050;background-color:#1e0010>`</span>call<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span></code></pre></div></li><li><p>해결 방법</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>TRUNCATE web_hooks CASCADE;
</span></span></code></pre></div><p>위 방법 대로 진행 하면 모든 웹 훅 설정이 삭제 됨</p></li></ul></li></ul><h3 id=about-cicd-page-internal-server-error-500>About CI/CD Page Internal Server Error 500</h3><p><a href=https://stackoverflow.com/questions/54216933/internal-server-error-500-while-accessing-gitlab-admin-runners target=_blank rel=noopener>Internal Server Error 500 while accessing $GITLAB/admin/runners</a></p><p><a href=https://stackoverflow.com/questions/54216933/internal-server-error-500-while-accessing-gitlab-admin-runners target=_blank rel=noopener>https://stackoverflow.com/questions/54216933/internal-server-error-500-while-accessing-gitlab-admin-runners</a></p><h4 id=gitlab-cicd-variable-error>Gitlab CICD Variable Error</h4><p>There was an error fetching the variables.</p><p>CICD메뉴 들어가면 위같이 나옴</p><p>실제 메뉴에 들어가면 값이 아무것도 없음</p><p>2FA로 암호화된 값이 전부 복사가 안됨</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>gitlabhq_production<span style=color:#f92672>=&gt;</span> SELECT <span style=color:#f92672>*</span> FROM <span style=color:#66d9ef>public</span>.<span style=color:#e6db74>&#34;ci_variables&#34;</span>;
</span></span></code></pre></div><p><a href=https://docs.gitlab.com/ee/raketasks/backup_restore.html#reset-cicd-variables target=_blank rel=noopener>Back up and restore GitLab | GitLab</a></p><ul><li><p>해결 방법
에러가 발생한 테이블 전부 삭제</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>gitlab<span style=color:#f92672>-</span>rails dbconsole
</span></span><span style=display:flex><span>SELECT <span style=color:#f92672>*</span> FROM <span style=color:#66d9ef>public</span>.<span style=color:#e6db74>&#34;ci_group_variables&#34;</span>;
</span></span><span style=display:flex><span>SELECT <span style=color:#f92672>*</span> FROM <span style=color:#66d9ef>public</span>.<span style=color:#e6db74>&#34;ci_variables&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DELETE FROM ci_group_variables;
</span></span><span style=display:flex><span>DELETE 0
</span></span><span style=display:flex><span>DELETE FROM ci_variables;
</span></span><span style=display:flex><span>DELETE 72
</span></span></code></pre></div></li></ul><h4 id=token-failure>token failure</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Project ⇒ runners_token
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Ci::Build ⇒ token
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Ci::Runner⇒ token
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Group failures: <span style=color:#ae81ff>13</span> ⇒ runner_token
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Project failures⇒ runners_token
</span></span></code></pre></div><p>하단의 쿼리 실행해보면 모든 토큰들이 쓰레기 값으로 채워져 있음</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>gitlab<span style=color:#f92672>-</span>rails dbconsole
</span></span><span style=display:flex><span>select runners_token from projects;
</span></span></code></pre></div><ul><li><p>해결 방법</p><p>관련 토큰들을 강제로 초기화 필요</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>gitlab<span style=color:#f92672>-</span>rails dbconsole
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>UPDATE projects SET runners_token <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>, runners_token_encrypted <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>UPDATE 350
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>select runners_token from namespaces ;
</span></span><span style=display:flex><span>UPDATE namespaces SET runners_token <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>, runners_token_encrypted <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>UPDATE 199
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>select runners_registration_token_encrypted  from application_settings;
</span></span><span style=display:flex><span>        runners_registration_token_encrypted
</span></span><span style=display:flex><span><span style=color:#f92672>--------------------------------------------------</span>
</span></span><span style=display:flex><span>    5DWiuL68oK<span style=color:#f92672>/+</span>bY0vxg74<span style=color:#f92672>/</span>xN<span style=color:#f92672>+</span>ZKUihKDMHCWnmQZJF0uy2gUU
</span></span><span style=display:flex><span>(1 row)
</span></span><span style=display:flex><span>UPDATE application_settings SET runners_registration_token_encrypted <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>UPDATE 1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>select token,token_encrypted   from ci_runners;
</span></span><span style=display:flex><span>    token <span style=color:#f92672>|</span>                 token_encrypted
</span></span><span style=display:flex><span><span style=color:#f92672>-------+--------------------------------------------------</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>|</span> 8S6u1fDNlvDLQcFB2x3GlARyQqEZQggaMoxv3LqYTRkRbC43
</span></span><span style=display:flex><span>        <span style=color:#f92672>|</span> 7RWfjr22sJLwTqMK3QDFnQ5cXahYk1nT6NlRiuehqQDKuEHG
</span></span><span style=display:flex><span>        <span style=color:#f92672>|</span> rXWSk4m<span style=color:#f92672>/</span>hfv1XacAmxfPhC5PQI3sgCKao2jkC7Sa3uzSHSb<span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>|</span> pDOIk76tqo<span style=color:#f92672>/</span>AZYAI8FzPuDFgZf4vHJMfPnPVF2M1MPulJhnY
</span></span><span style=display:flex><span>        <span style=color:#f92672>|</span> 6CSKlKPBoorGSsQ<span style=color:#f92672>/</span>5DLxuzNOb6M<span style=color:#f92672>/</span>IQtiwjYkxszjgryQwSHN
</span></span><span style=display:flex><span>        <span style=color:#f92672>|</span> txOI0r7Pl5fvR5pB3A3biyUoIKGaKmceSYsywq3II2Jisl<span style=color:#f92672>/</span>0
</span></span><span style=display:flex><span>        <span style=color:#f92672>|</span> jSmT2L<span style=color:#f92672>+</span>ds<span style=color:#f92672>/</span>freJAC5QzDpSBORLllSKbAs83<span style=color:#f92672>+</span>ShsF0v3hWPfe
</span></span><span style=display:flex><span>        <span style=color:#f92672>|</span> 5BaLp42RnoPkUJE54VPFnw1gQ7p93aDThn1lk61PbNjJsM8J
</span></span><span style=display:flex><span>        <span style=color:#f92672>|</span> rgyclbStrfTbTs1O<span style=color:#f92672>+</span>yf1izFjYPkZH4iI<span style=color:#f92672>/</span>rhNBb0lBuEVbkRJ
</span></span><span style=display:flex><span>        <span style=color:#f92672>|</span> iBWXpqqKoY77TIESxBznnhFMYLw8ilpbIkx7u0ZjtRbEEGt3
</span></span><span style=display:flex><span>        <span style=color:#f92672>|</span> khnRl4adgbHiVZEo3S7zog5LTbA8eTpRG2n<span style=color:#f92672>/</span>HqUG<span style=color:#f92672>+</span>xS<span style=color:#f92672>/</span>O<span style=color:#f92672>/</span>79
</span></span><span style=display:flex><span>        <span style=color:#f92672>|</span> rj<span style=color:#f92672>+</span>9uJCyjqOTNKYn6xfSuh5fIpA<span style=color:#f92672>/</span>Xs83kXe6MT9wB<span style=color:#f92672>+</span>7aEHC2
</span></span><span style=display:flex><span>        <span style=color:#f92672>|</span> rgzdsYabranYeqVL6lKb9Fp<span style=color:#f92672>+</span>UbLZBSk<span style=color:#f92672>/</span>ydaiaOMGb75<span style=color:#f92672>/</span>NHTx
</span></span><span style=display:flex><span>        <span style=color:#f92672>|</span> sWuohKO9kLvSMIw7<span style=color:#f92672>+</span>VXhuyFtZoxxMyggYL8Hgvn0m0VPFGc9
</span></span><span style=display:flex><span>        <span style=color:#f92672>|</span> pTWU2IrMqorkV8ARmR6EgTAvWKMtrG3Hxa3eVhcwx7q0K<span style=color:#f92672>+</span>HW
</span></span><span style=display:flex><span>        <span style=color:#f92672>|</span> 73WUzfOwhoj3SIUbnEnAoyF7Y7<span style=color:#f92672>/</span>ZyTvlIkoYEjZq6gC6ZpMC
</span></span><span style=display:flex><span>        <span style=color:#f92672>|</span> mTWhuJKCopLtc8I12RXzlQ9qV5l4Z<span style=color:#f92672>/</span>69oHLyTDJvA1kb4cVd
</span></span><span style=display:flex><span>        <span style=color:#f92672>|</span> rBDSkaCdj5LWZ4MAghfTvxIuf6f99c2civIsqeIp2NZQ9<span style=color:#f92672>+</span>bp
</span></span><span style=display:flex><span>        <span style=color:#f92672>|</span> uweomoWAqvTbWMxJmg3zgAZ4e7DtO7<span style=color:#f92672>/</span>IcTavSgYsmJzwfnqn
</span></span><span style=display:flex><span>        <span style=color:#f92672>|</span> pnGLha2CsJLJTsQp6zfcvg9TT72aArFPVXALqzyiE<span style=color:#f92672>/</span>hcztZO
</span></span><span style=display:flex><span>        <span style=color:#f92672>|</span> mn6clbWRoKbZSKNLnBzEnjp<span style=color:#f92672>+</span>Vr<span style=color:#f92672>+</span>BI<span style=color:#f92672>/</span>veDyFuDXV2toMXV0ss
</span></span><span style=display:flex><span>        <span style=color:#f92672>|</span> jDeLiPPVpo6UL60J6g7ktARLZJNW5zDzKaD2UFo3SX0n4aYq
</span></span><span style=display:flex><span>        <span style=color:#f92672>|</span> nj<span style=color:#f92672>+</span>Xpp7VkanSV48bmifXuyJvbJ0vBRGYztfZffd5JYEkQrmV
</span></span><span style=display:flex><span>        <span style=color:#f92672>|</span> 5B<span style=color:#f92672>/</span>SopiPtLHKRKYf1QX3tEFfZJAJrv2ZEeGQeLwXrnZsB8GH
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>UPDATE ci_runners SET token <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>, token_encrypted <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>UPDATE 81
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>select token,token_encrypted   from ci_builds ;
</span></span><span style=display:flex><span>    token <span style=color:#f92672>|</span>                 token_encrypted
</span></span><span style=display:flex><span><span style=color:#f92672>-------+--------------------------------------------------</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>|</span> rBCGkbKcvrGVR6JP5x7vpA8rXo<span style=color:#f92672>/</span>hPT9WwYVXFjtfaSEVeFdc
</span></span><span style=display:flex><span>        <span style=color:#f92672>|</span> 5H<span style=color:#f92672>+</span>305<span style=color:#f92672>+</span>w35jQT8EA<span style=color:#f92672>/</span>y<span style=color:#f92672>/</span>ilDZLIKQ8yf<span style=color:#f92672>/</span>mbylVg<span style=color:#f92672>+</span>c8oKQ7SVpk
</span></span><span style=display:flex><span>UPDATE ci_builds SET token <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>, token_encrypted <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>UPDATE 60857
</span></span></code></pre></div></li></ul><h4 id=cipipelinevariable-failures>Ci::PipelineVariable failures</h4><p>하단의 쿼리를 실행 하면, 하단 처럼 키는 있지만 이에 매칭 되는 값이 없음</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>gitlab<span style=color:#f92672>-</span>rails dbconsole
</span></span><span style=display:flex><span>select <span style=color:#f92672>*</span> from ci_pipeline_variables;
</span></span><span style=display:flex><span>id <span style=color:#f92672>|</span>     key     <span style=color:#f92672>|</span> value <span style=color:#f92672>|</span>                       encrypted_value                        <span style=color:#f92672>|</span>   encrypted_value_salt    <span style=color:#f92672>|</span>    encrypted_value_iv    <span style=color:#f92672>|</span> pipeline_id <span style=color:#f92672>|</span> variable_type
</span></span><span style=display:flex><span><span style=color:#f92672>----+-------------+-------+--------------------------------------------------------------+---------------------------+--------------------------+-------------+---------------</span>
</span></span><span style=display:flex><span>    1 <span style=color:#f92672>|</span> SSH_PASS    <span style=color:#f92672>|</span>       <span style=color:#f92672>|</span> w8qzJD5aSsaWbjfPPlpLBQ<span style=color:#f92672>==</span>                                    <span style=color:#f92672>+|</span> _MiTYiSslBO0Nv7s0tcmF0Q<span style=color:#f92672>==+|</span> MpyPIrH6HSiggmg<span style=color:#f92672>+</span>zPi7fg<span style=color:#f92672>==+|</span>        1256 <span style=color:#f92672>|</span>             1
</span></span><span style=display:flex><span>    <span style=color:#f92672>|</span>             <span style=color:#f92672>|</span>       <span style=color:#f92672>|</span>                                                              <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>|</span>                          <span style=color:#f92672>|</span>             <span style=color:#f92672>|</span>
</span></span></code></pre></div><ul><li><p>해결방법</p><p>CI 변수 테이블 전부 삭제</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>gitlab<span style=color:#f92672>-</span>rails dbconsole
</span></span><span style=display:flex><span>delete from ci_pipeline_variables;
</span></span><span style=display:flex><span>DELETE 6
</span></span></code></pre></div></li></ul><h4 id=개인-access-token>개인 Access token</h4><p>위 과정에서 오류가 있는 테이블은 전부 삭제를 했고, deploy_tokens을 찾기 위해 테이블 조회를 한 후 deploy_tokens 테이블 삭제 필요</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>gitlab<span style=color:#f92672>-</span>rails dbconsole
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>SELECT <span style=color:#f92672>*</span> FROM pg_catalog.<span style=color:#a6e22e>pg_tables</span> where tablename like <span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>%</span>token<span style=color:#f92672>%</span><span style=color:#960050;background-color:#1e0010>&#39;</span>;
</span></span><span style=display:flex><span>select <span style=color:#f92672>*</span> from deploy_tokens;
</span></span></code></pre></div><ul><li><p>해결 방법</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>gitlab<span style=color:#f92672>-</span>rails dbconsole
</span></span><span style=display:flex><span>delete from deploy_tokens;
</span></span></code></pre></div></li></ul><h3 id=user-failures>User Failures</h3><h4 id=otp_secret>otp_secret</h4><p>해당 이슈가 검출 되어도 시스템에 영향은 없음</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>I, <span style=color:#f92672>[</span>2023<span style=color:#f92672>-</span>03<span style=color:#f92672>-</span>21T11:32:21.<span style=color:#a6e22e>395183</span> <span style=color:#960050;background-color:#1e0010>#</span>1925<span style=color:#f92672>]</span>  INFO <span style=color:#f92672>--</span> : <span style=color:#f92672>-</span> User failures: 1
</span></span><span style=display:flex><span>D, <span style=color:#f92672>[</span>2023<span style=color:#f92672>-</span>03<span style=color:#f92672>-</span>21T11:32:21.<span style=color:#a6e22e>395311</span> <span style=color:#960050;background-color:#1e0010>#</span>1925<span style=color:#f92672>]</span> DEBUG <span style=color:#f92672>--</span> :   <span style=color:#f92672>-</span> User<span style=color:#f92672>[</span>25<span style=color:#f92672>]</span>: otp_secret
</span></span></code></pre></div><p>하지만 해결 하고 싶다면 하고 싶다면 하단의 쿼리 실행</p><ul><li><p>해결 방법</p><p>DB에서 otp 관련 컬럼들 검색</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>$ gitlab<span style=color:#f92672>-</span>rails db
</span></span><span style=display:flex><span>gitlabhq_production<span style=color:#f92672>=&gt;</span> select username,id,encrypted_otp_secret,encrypted_otp_secret_iv,encrypted_otp_secret_salt,otp_secret_expires_at from users;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>username      <span style=color:#f92672>|</span> id  <span style=color:#f92672>|</span> encrypted_otp_secret <span style=color:#f92672>|</span> encrypted_otp_secret_iv  <span style=color:#f92672>|</span> encrypted_otp_secret_salt <span style=color:#f92672>|</span> otp_secret_expires_at
</span></span><span style=display:flex><span><span style=color:#f92672>-------------------+-----+----------------------+--------------------------+---------------------------+-----------------------</span>
</span></span><span style=display:flex><span>lunar.<span style=color:#a6e22e>kim</span>      <span style=color:#f92672>|</span>  25 <span style=color:#f92672>|</span>                      <span style=color:#f92672>|</span> 0RlunopfsqEk4<span style=color:#75715e>//Zw1TaAQ==+| _rOhq1EDp+u+ag27VknisIw==+|</span>
</span></span></code></pre></div><p>암호화된 otp값이 실제론 존재 하지 않아서 해당 otp 삭제 및 모든 유저 암호화 OTP 초기화</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>gitlabhq_production<span style=color:#f92672>=&gt;</span> update users set encrypted_otp_secret_iv<span style=color:#f92672>=</span><span style=color:#66d9ef>null</span>, encrypted_otp_secret_salt<span style=color:#f92672>=</span><span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>UPDATE 143
</span></span></code></pre></div><p>위 과정을 모두 마치고 다시 오류 검출 시도</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>$ gitlab<span style=color:#f92672>-</span>rake gitlab:doctor:secrets VERBOSE<span style=color:#f92672>=</span>1 <span style=color:#f92672>--</span>trace
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>I, <span style=color:#f92672>[</span>2023<span style=color:#f92672>-</span>03<span style=color:#f92672>-</span>21T12:19:15.<span style=color:#a6e22e>962304</span> <span style=color:#960050;background-color:#1e0010>#</span>4092<span style=color:#f92672>]</span>  INFO <span style=color:#f92672>--</span> : <span style=color:#f92672>-</span> User failures: 0
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>I, <span style=color:#f92672>[</span>2023<span style=color:#f92672>-</span>03<span style=color:#f92672>-</span>21T12:19:22.<span style=color:#a6e22e>490768</span> <span style=color:#960050;background-color:#1e0010>#</span>4092<span style=color:#f92672>]</span>  INFO <span style=color:#f92672>--</span> : Total: 0 <span style=color:#a6e22e>row</span>(s) affected
</span></span><span style=display:flex><span>I, <span style=color:#f92672>[</span>2023<span style=color:#f92672>-</span>03<span style=color:#f92672>-</span>21T12:19:22.<span style=color:#a6e22e>490833</span> <span style=color:#960050;background-color:#1e0010>#</span>4092<span style=color:#f92672>]</span>  INFO <span style=color:#f92672>--</span> : Done<span style=color:#f92672>!</span>
</span></span></code></pre></div></li></ul></div><div class="row ps-3 pe-3"><div class="col-md-6 share-buttons"><strong>Share on:</strong>
<a class="btn icon-button bg-facebook" href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fcodex-devlab.github.io%2fposts%2ftools%2fsub-gitlab%2fgitlab-upgrade%2f" target=_blank><i class="fab fa-facebook"></i>
</a><a class="btn icon-button bg-twitter" href="https://twitter.com/share?url=https%3a%2f%2fcodex-devlab.github.io%2fposts%2ftools%2fsub-gitlab%2fgitlab-upgrade%2f&text=GitLab%20Upgrade&via=CodeXlog" target=_blank><i class="fab fa-twitter"></i>
</a><a class="btn icon-button bg-linkedin" href="https://www.linkedin.com/shareArticle?url=https%3a%2f%2fcodex-devlab.github.io%2fposts%2ftools%2fsub-gitlab%2fgitlab-upgrade%2f&title=GitLab%20Upgrade" target=_blank><i class="fab fa-linkedin"></i>
</a><a class="btn icon-button" href="mailto:?subject=GitLab%20Upgrade&body=https%3a%2f%2fcodex-devlab.github.io%2fposts%2ftools%2fsub-gitlab%2fgitlab-upgrade%2f" target=_blank><i class="fas fa-envelope-open-text"></i></a></div><div class="col-md-6 btn-improve-page"><a href=https://github.com/codex-devlab/codex-devlab.github.io/edit/main/content/posts/tools/sub-gitlab/gitlab-upgrade/index.md title="Improve this page" target=_blank rel=noopener><i class="fas fa-code-branch"></i>
Improve this page</a></div></div><hr><div class="row next-prev-navigator"><div class="col-md-6 previous-article"><a href=/posts/os/sub-window/window-git-setting/ title="Git 설치 및 초기설정" class="btn filled-button"><div><i class="fas fa-chevron-circle-left"></i> Prev</div><div class=next-prev-text>Git 설치 및 초기설정</div></a></div></div><hr><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname=="localhost")return;var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,t="codex-devlab-github-io",e.src="//"+t+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script><noscript>Please enable JavaScript to view the
<a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div><a id=scroll-to-top class=btn type=button data-bs-toggle=tooltip data-bs-placement=left title="Scroll to top"><i class="fas fa-chevron-circle-up"></i></a></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center ps-3">Table of Contents</h5><hr><div class=toc><nav id=TableOfContents><ul><li><a href=#gitlab-upgrade-history>Gitlab Upgrade History</a><ul><li><a href=#upgrade-path>Upgrade Path</a></li><li><a href=#upgrade-guide>Upgrade Guide</a></li></ul></li><li><a href=#debug-history>Debug History</a><ul><li><a href=#gitlab-jira-integration-issue>Gitlab Jira Integration Issue</a></li><li><a href=#git-upgrade-issue>Git Upgrade Issue</a><ul><li><a href=#registry-not-exist>Registry Not Exist</a></li><li><a href=#storage-hashing>storage Hashing</a></li><li><a href=#readonly-project>readonly project</a></li><li><a href=#service-not-enable>service not enable</a></li><li><a href=#db-error>DB Error</a></li><li><a href=#projectimportdata-failures>ProjectImportData failures</a></li><li><a href=#fix-integrations-and-webhooks>Fix integrations and webhooks</a></li><li><a href=#about-cicd-page-internal-server-error-500>About CI/CD Page Internal Server Error 500</a><ul><li><a href=#gitlab-cicd-variable-error>Gitlab CICD Variable Error</a></li><li><a href=#token-failure>token failure</a></li><li><a href=#cipipelinevariable-failures>Ci::PipelineVariable failures</a></li><li><a href=#개인-access-token>개인 Access token</a></li></ul></li><li><a href=#user-failures>User Failures</a><ul><li><a href=#otp_secret>otp_secret</a></li></ul></li></ul></li></ul></li></ul></nav></div></div></section></div><footer id=footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-start"><div class="col-md-4 col-sm-12"><h5>Navigation</h5><ul><li class=nav-item><a class=smooth-scroll href=https://codex-devlab.github.io/#recent-posts>Recent Posts</a></li><li class=nav-item><a class=smooth-scroll href=/tags/>Tags</a></li></ul></div><div class="col-md-4 col-sm-12"><h5>Contact me:</h5><ul><li><a href=mailto:codex.devlab@gmail.com target=_blank rel=noopener><span><i class="fas fa-envelope"></i></span> <span>codex.devlab@gmail.com</span></a></li><li><a href=https://github.com/ehdwn1991 target=_blank rel=noopener><span><i class="fab fa-github"></i></span> <span>ehdwn1991</span></a></li><li><a href=https://www.linkedin.com/in/dongju-son target=_blank rel=noopener><span><i class="fab fa-linkedin"></i></span> <span>DongjuSon</span></a></li></ul></div></div></div><hr><div class=container><p id=disclaimer><strong>Liability Notice:</strong> This theme is under MIT license. So, you can use it for non-commercial, commercial, or private uses. You can modify or distribute the theme without requiring any permission from the theme author. However, the theme author does not provide any warranty or takes any liability for any issue with the theme.</p></div></footer><script src=/application.5c1b4fcf22483f6df2703ba146ca9ffdf10eef71c2abf801d2b9a23d06c89341.js integrity="sha256-XBtPzyJIP23ycDuhRsqf/fEO73HCq/gB0rmiPQbIk0E=" defer></script></body></html>